<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Value Input</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f5f5;
        padding: 10px;
        line-height: 1.3;
        font-size: 15px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: center;
      }

      .header h1 {
        font-size: 1.6em;
        margin-bottom: 5px;
        font-weight: 300;
      }

      .header p {
        opacity: 0.9;
        font-size: 0.9em;
      }

      .date-picker-container {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .date-picker-container label {
        font-size: 0.9em;
        opacity: 0.9;
        font-weight: 500;
      }

      .date-picker {
        padding: 6px 10px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9em;
        outline: none;
        transition: all 0.3s ease;
      }

      .date-picker:focus {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .date-picker::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
      }      .assets-container {
        padding: 15px;
      }

      .asset-group {
        margin-bottom: 12px;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        overflow: hidden;
        transition: box-shadow 0.3s ease;
      }

      .asset-group:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }      .asset-header {
        background: #f8f9fa;
        padding: 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
      }

      .asset-header:hover {
        background: #e9ecef;
      }

      .asset-header.active {
        background: #e3f2fd;
      }

      .asset-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .asset-date-picker {
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        color: #333;
        font-size: 0.8em;
        outline: none;
        transition: all 0.3s ease;
        min-width: 130px;
      }

      .asset-date-picker:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      }

      .asset-date-picker.overridden {
        border-color: #f57c00;
        background-color: #fff8e1;
      }.asset-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .asset-type-badge {
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.7em;
        font-weight: 600;
        text-transform: uppercase;
      }

      .type-simple {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .type-investment {
        background: #fff3e0;
        color: #f57c00;
      }

      .type-composite {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .type-stock {
        background: #e3f2fd;
        color: #1976d2;
      }      .asset-name {
        font-size: 1em;
        font-weight: 600;
        color: #333;
      }

      .currency-label {
        background: #212529;
        color: white;
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 0.7em;
        margin-left: 8px;
      }

      .collapse-icon {
        font-size: 1.2em;
        transition: transform 0.3s ease;
        color: #666;
      }

      .collapse-icon.rotated {
        transform: rotate(180deg);
      }

      .asset-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        background: white;
      }      .asset-content.expanded {
        max-height: 600px;
        padding: 15px;
        overflow-y: auto;
      }

      .input-group {
        margin-bottom: 12px;
      }

      .input-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
        font-size: 0.9em;
      }

      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #e1e5e9;
        border-radius: 4px;
        font-size: 0.9em;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }      .value-summary {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
      }

      .value-summary.has-value {
        display: block;
      }

      .summary-text {
        color: #666;
        font-size: 0.8em;
      }      .summary-value {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
        margin-top: 3px;
      }

      .transfers-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e1e5e9;
      }      .transfers-header {
        font-weight: 600;
        color: #333;
        font-size: 0.9em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .transfers-help {
        font-size: 0.75em;
        color: #666;
        font-weight: normal;
        font-style: italic;
        margin-left: auto;
      }

      .transfers-icon {
        color: #667eea;
        font-size: 1em;
      }      .transfer-item {
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 8px;
        position: relative;
      }

      .transfer-item[data-is-paired="true"] {
        background: #f0f8ff;
        border-color: #cce7ff;
      }

      .transfer-item[data-is-paired="true"]::before {
        content: "↔";
        position: absolute;
        top: 4px;
        left: 4px;
        color: #667eea;
        font-size: 0.8em;
        font-weight: bold;
      }

      .transfer-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .transfer-row:last-child {
        margin-bottom: 0;
      }      .transfer-type-select {
        flex: 0 0 70px;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 0.8em;
        background: white;
      }      .transfer-asset-select {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 0.8em;
        background: white;
        min-width: 140px;
      }
         
      .transfer-date-input {
        flex: 0 0 100px;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 0.8em;
      }

      .transfer-amount-input {
        flex: 0 0 65px;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 0.8em;
        text-align: right;
      }.transfer-description-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 0.8em;
      }

      .transfer-description-input::placeholder {
        color: #999;
      }

      .remove-transfer-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .remove-transfer-btn:hover {
        background: #c82333;
      }

      .add-transfer-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 0.8em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .add-transfer-btn:hover {
        background: #218838;
      }

      .transfer-summary {
        margin-top: 8px;
        padding: 8px;
        background: #e8f5e8;
        border-radius: 4px;
        font-size: 0.8em;
        color: #2e7d32;
        display: none;
      }

      .transfer-summary.has-transfers {
        display: block;
      }
      
      @media (max-width: 768px) {
        .container {
          margin: 0;
          border-radius: 0;
        }

        .header {
          padding: 12px;
        }

        .header h1 {
          font-size: 1.4em;
        }

        .assets-container {
          padding: 12px;
        }

        .asset-header {
          padding: 10px;
        }

        .asset-content.expanded {
          padding: 12px;
        }

        .asset-header-right {
          gap: 5px;
        }

        .asset-date-picker {
          font-size: 0.7em;
          padding: 3px 6px;
          min-width: 110px;
        }

        .date-picker-container {
          flex-direction: column;
          gap: 5px;
        }

        .transfer-row {
          flex-direction: column;
          gap: 6px;
        }        .transfer-type-select,
        .transfer-asset-select,
        .transfer-date-input,
        .transfer-amount-input {
          flex: none;
          width: 100%;
        }.transfers-section {
          margin-top: 12px;
          padding-top: 12px;
        }

        .transfer-item {
          padding: 10px;
        }

        .transfers-help {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Asset Portfolio</h1>
        <p>Update current values for your assets</p>        
        <div class="date-picker-container">
          <label for="portfolioDate">As of:</label>
          <input type="date" id="portfolioDate" class="date-picker" />
        </div>
      </div>     
      <div class="assets-container" id="assetsContainer">
        <!-- Assets will be generated dynamically -->
      </div>
    </div>
    <script>      // Assets data - default values
      let assets = [
      ];

      // Track which asset groups have overridden dates
      let overriddenDates = new Set();      // Initialize date picker with today's date
      function initializeDatePicker() {
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        const headerDatePicker = document.getElementById('portfolioDate');
        headerDatePicker.value = formattedDate;
        
        // Add event listener for header date picker changes
        headerDatePicker.addEventListener('change', handleHeaderDateChange);
      }

      // Initialize asset date pickers with header date value
      function initializeAssetDatePickers() {
        const headerDate = document.getElementById('portfolioDate').value;
        const assetDatePickers = document.querySelectorAll('.asset-date-picker');
        
        assetDatePickers.forEach(picker => {
          if (!overriddenDates.has(getAssetId(picker))) {
            picker.value = headerDate;
            picker.classList.remove('overridden');
          }
        });
      }

      // Handle header date picker changes
      function handleHeaderDateChange() {
        const headerDate = document.getElementById('portfolioDate').value;
        const assetDatePickers = document.querySelectorAll('.asset-date-picker');
        
        assetDatePickers.forEach(picker => {
          const assetId = getAssetId(picker);
          // Only update if this asset date hasn't been overridden
          if (!overriddenDates.has(assetId)) {
            picker.value = headerDate;
            picker.classList.remove('overridden');
          }
        });
      }

      // Handle individual asset date picker changes
      function handleAssetDateChange(picker, event) {
        event.stopPropagation();
        const assetId = getAssetId(picker);
        const headerDate = document.getElementById('portfolioDate').value;
        
        if (picker.value !== headerDate) {
          // Mark this asset as having an overridden date
          overriddenDates.add(assetId);
          picker.classList.add('overridden');
        } else {
          // If user sets it back to header date, remove override
          overriddenDates.delete(assetId);
          picker.classList.remove('overridden');
        }
      }

      // Get asset ID from a date picker element
      function getAssetId(picker) {
        const assetGroup = picker.closest('.asset-group');
        return assetGroup.getAttribute('data-asset-id');
      }

      function generateAssetGroup(asset) {
        const currency = asset.currency || "CNY";
        const currencySymbol = currency === "USD" ? "$" : "¥";
        const currencyLabel =
          currency === "USD"
            ? `<span class="currency-label">${currency}</span>`
            : "";

        let inputFields = "";
        let summaryText = "";
        let summaryValue = "";        // Generate input fields based on asset type
        switch (asset.type) {
          case "simple":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "investment":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "composite":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Current Market Value</label>
                            <input type="number" class="input-field" placeholder="Enter current market value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "stock":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Units/Shares</label>
                            <input type="number" class="input-field" placeholder="Number of shares" 
                                   oninput="updateStockSummary(this)" step="1" min="0" data-field="shares">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Stock Price</label>
                            <input type="number" class="input-field" placeholder="Price per share" 
                                   oninput="updateStockSummary(this)" step="0.01" min="0" data-field="price">
                        </div>`;
            summaryText = "Total Value";
            summaryValue = `${currencySymbol}0.00`;
            break;
        }        return `
                <div class="asset-group" data-asset-id="${asset.id || asset.name}">
                    <div class="asset-header active" onclick="toggleAsset(this)">
                        <div class="asset-info">
                            <span class="asset-type-badge type-${asset.type}">${
          asset.type.charAt(0).toUpperCase() + asset.type.slice(1)
        }</span>
                            <span class="asset-name">${asset.name}</span>
                            ${currencyLabel}
                        </div>
                        <div class="asset-header-right">
                            <input type="date" class="asset-date-picker" 
                                   onchange="handleAssetDateChange(this, event)" 
                                   onclick="event.stopPropagation()" />
                            <span class="collapse-icon rotated">▼</span>
                        </div>
                    </div>
                    <div class="asset-content expanded">
                        ${inputFields}
                        ${asset.type === 'stock' ? `
                        <div class="value-summary">
                            <div class="summary-text">${summaryText}</div>
                            <div class="summary-value">${summaryValue}</div>
                        </div>` : ''}
                          <div class="transfers-section">
                            <div class="transfers-header">
                                <span class="transfers-icon">⇄</span>
                                Transfers
                                <span class="transfers-help">Auto-paired with destination</span>
                            </div>
                            <div class="transfers-container" data-asset-id="${asset.id || asset.name}">
                                <!-- Transfer items will be added dynamically -->
                            </div>
                            <button type="button" class="add-transfer-btn" onclick="addTransfer('${asset.id || asset.name}')">
                                <span>+</span> Add Transfer
                            </button>
                            <div class="transfer-summary">
                                <span class="transfer-summary-text"></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }      function generateAllAssets() {
        const container = document.getElementById("assetsContainer");
        container.innerHTML = assets
          .map((asset) => generateAssetGroup(asset))
          .join("");
        
        // Initialize asset date pickers with the header date value
        initializeAssetDatePickers();
        
        // Update all transfer asset dropdowns
        updateAllTransferAssetDropdowns();
      }

      function updateAllTransferAssetDropdowns() {
        // Update dropdowns in existing transfer items when assets change
        const transferSelects = document.querySelectorAll('.transfer-asset-select');
        transferSelects.forEach(select => {
          const transferItem = select.closest('.transfer-item');
          const assetGroup = transferItem.closest('.asset-group');
          const currentAssetId = assetGroup.dataset.assetId;
          const selectedValue = select.value;
          
          // Get list of other assets for the dropdown
          const otherAssets = assets.filter(asset => (asset.id || asset.name) !== currentAssetId);
          const assetOptions = '<option value="">Select asset...</option>' + 
            otherAssets.map(asset => 
              `<option value="${asset.id || asset.name}">${asset.name}</option>`
            ).join('');
          
          select.innerHTML = assetOptions;
          // Restore selected value if it still exists
          if (selectedValue && otherAssets.some(asset => (asset.id || asset.name) === selectedValue)) {
            select.value = selectedValue;
          }
        });
      }

      function toggleAsset(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector(".collapse-icon");

        // Toggle active state
        header.classList.toggle("active");

        // Toggle content visibility
        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          icon.classList.remove("rotated");
        } else {
          content.classList.add("expanded");
          icon.classList.add("rotated");
        }
      }

      function updateSummary(input) {
        const assetGroup = input.closest(".asset-group");
        const summary = assetGroup.querySelector(".value-summary");
        const summaryValue = assetGroup.querySelector(".summary-value");
        const assetName = assetGroup.querySelector(".asset-name").textContent;

        const value = parseFloat(input.value) || 0;

        if (value > 0) {
          summary.classList.add("has-value");

          // Determine currency based on asset
          let currency = "¥";
          if (assetName === "StockAward") {
            currency = "$";
          }

          summaryValue.textContent = `${currency}${value.toLocaleString(
            "en-US",
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            }
          )}`;
        } else {
          summary.classList.remove("has-value");
        }
      }      function updateStockSummary(input) {
        const assetGroup = input.closest(".asset-group");
        const summary = assetGroup.querySelector(".value-summary");
        const summaryValue = assetGroup.querySelector(".summary-value");
        const assetName = assetGroup.querySelector(".asset-name").textContent;

        // Get both shares and price inputs
        const sharesInput = assetGroup.querySelector('input[data-field="shares"]');
        const priceInput = assetGroup.querySelector('input[data-field="price"]');
        
        const shares = parseInt(sharesInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const totalValue = shares * price;

        if (shares > 0 && price > 0) {
          summary.classList.add("has-value");

          // Determine currency based on asset
          let currency = "¥";
          if (assetName === "StockAward") {
            currency = "$";
          }

          summaryValue.textContent = `${currency}${totalValue.toLocaleString(
            "en-US",
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            }
          )}`;        } else {
          summary.classList.remove("has-value");
        }
      }      // Transfer management functions
      let transferIdCounter = 0;
      let transferPairs = new Map(); // Maps transfer IDs to their corresponding pair IDs

      function addTransfer(assetId) {
        const transfersContainer = document.querySelector(`.transfers-container[data-asset-id="${assetId}"]`);
        if (!transfersContainer) return;

        const transferId = `transfer_${transferIdCounter++}`;
        const transferItem = createTransferItem(transferId, assetId);
        transfersContainer.appendChild(transferItem);
        
        updateTransferSummary(assetId);
      }      function createTransferItem(transferId, currentAssetId, isPaired = false) {
        const transferDiv = document.createElement('div');
        transferDiv.className = 'transfer-item';
        transferDiv.dataset.transferId = transferId;
        transferDiv.dataset.isPaired = isPaired;
        
        // Get list of other assets for the dropdown
        const otherAssets = assets.filter(asset => (asset.id || asset.name) !== currentAssetId);
        const assetOptions = otherAssets.map(asset => 
          `<option value="${asset.id || asset.name}">${asset.name}</option>`
        ).join('');        transferDiv.innerHTML = `
          <button type="button" class="remove-transfer-btn" onclick="removeTransfer('${transferId}', '${currentAssetId}')" title="Remove transfer">×</button>
          <div class="transfer-row">
            <select class="transfer-type-select" onchange="handleTransferChange('${transferId}', '${currentAssetId}')">
              <option value="to">To</option>
              <option value="from">From</option>
            </select>
            <select class="transfer-asset-select" onchange="handleTransferChange('${transferId}', '${currentAssetId}')">
              <option value="">Select asset...</option>
              ${assetOptions}
            </select>
            <input type="date" class="transfer-date-input" 
                   onchange="handleTransferChange('${transferId}', '${currentAssetId}')" />
            <input type="number" class="transfer-amount-input" placeholder="Amount" step="0.01" min="0" 
                   oninput="handleTransferChange('${transferId}', '${currentAssetId}')" />
          </div>
          <div class="transfer-row">
            <input type="text" class="transfer-description-input" placeholder="Description (optional)" 
                   oninput="handleDescriptionChange('${transferId}', '${currentAssetId}')" />
          </div>
        `;

        return transferDiv;
      }      function removeTransfer(transferId, assetId) {
        const transferItem = document.querySelector(`[data-transfer-id="${transferId}"]`);
        if (transferItem) {
          // Remove paired transfer if it exists
          const pairedTransferId = transferPairs.get(transferId);
          if (pairedTransferId) {
            const pairedTransferItem = document.querySelector(`[data-transfer-id="${pairedTransferId}"]`);
            if (pairedTransferItem) {
              const pairedAssetGroup = pairedTransferItem.closest('.asset-group');
              const pairedAssetId = pairedAssetGroup.dataset.assetId;
              pairedTransferItem.remove();
              updateTransferSummary(pairedAssetId);
            }
            transferPairs.delete(transferId);
            transferPairs.delete(pairedTransferId);
          }
          
          transferItem.remove();
          updateTransferSummary(assetId);
        }
      }      
      
      function handleTransferChange(transferId, currentAssetId) {
        const transferItem = document.querySelector(`[data-transfer-id="${transferId}"]`);
        if (!transferItem) return;

        const type = transferItem.querySelector('.transfer-type-select').value;
        const targetAssetId = transferItem.querySelector('.transfer-asset-select').value;
        const date = transferItem.querySelector('.transfer-date-input').value;
        const amount = transferItem.querySelector('.transfer-amount-input').value;
        const description = transferItem.querySelector('.transfer-description-input').value;

        // Update current asset summary
        updateTransferSummary(currentAssetId);

        // Handle paired transfer
        if (targetAssetId && amount && parseFloat(amount) > 0) {
          createOrUpdatePairedTransfer(transferId, currentAssetId, targetAssetId, type, amount, description, date);
        } else {
          // Remove paired transfer if target asset or amount is cleared
          removePairedTransfer(transferId);
        }
      }      function handleDescriptionChange(transferId, currentAssetId) {
        const transferItem = document.querySelector(`[data-transfer-id="${transferId}"]`);
        if (!transferItem) return;

        const description = transferItem.querySelector('.transfer-description-input').value;
        
        // Update paired transfer description
        const pairedTransferId = transferPairs.get(transferId);
        if (pairedTransferId) {
          const pairedTransferItem = document.querySelector(`[data-transfer-id="${pairedTransferId}"]`);
          if (pairedTransferItem) {
            const pairedDescriptionInput = pairedTransferItem.querySelector('.transfer-description-input');
            pairedDescriptionInput.value = description;
          }
        }
      }

      function createOrUpdatePairedTransfer(transferId, sourceAssetId, targetAssetId, sourceType, amount, description, date) {
        const targetAssetGroup = document.querySelector(`[data-asset-id="${targetAssetId}"]`);
        if (!targetAssetGroup) return;

        const targetTransfersContainer = targetAssetGroup.querySelector('.transfers-container');
        if (!targetTransfersContainer) return;

        // Check if paired transfer already exists
        let pairedTransferId = transferPairs.get(transferId);
        let pairedTransferItem = pairedTransferId ? document.querySelector(`[data-transfer-id="${pairedTransferId}"]`) : null;

        // If paired transfer doesn't exist or is in wrong container, create new one
        if (!pairedTransferItem || !targetTransfersContainer.contains(pairedTransferItem)) {
          // Remove old paired transfer if it exists
          if (pairedTransferItem) {
            pairedTransferItem.remove();
          }

          // Create new paired transfer
          pairedTransferId = `transfer_${transferIdCounter++}`;
          pairedTransferItem = createTransferItem(pairedTransferId, targetAssetId, true);
          targetTransfersContainer.appendChild(pairedTransferItem);

          // Link the transfers
          transferPairs.set(transferId, pairedTransferId);
          transferPairs.set(pairedTransferId, transferId);
        }        // Update paired transfer values
        const pairedType = sourceType === 'to' ? 'from' : 'to';
        pairedTransferItem.querySelector('.transfer-type-select').value = pairedType;
        pairedTransferItem.querySelector('.transfer-asset-select').value = sourceAssetId;
        pairedTransferItem.querySelector('.transfer-date-input').value = date;
        pairedTransferItem.querySelector('.transfer-amount-input').value = amount;
        pairedTransferItem.querySelector('.transfer-description-input').value = description;

        // Update target asset summary
        updateTransferSummary(targetAssetId);
      }

      function removePairedTransfer(transferId) {
        const pairedTransferId = transferPairs.get(transferId);
        if (pairedTransferId) {
          const pairedTransferItem = document.querySelector(`[data-transfer-id="${pairedTransferId}"]`);
          if (pairedTransferItem) {
            const pairedAssetGroup = pairedTransferItem.closest('.asset-group');
            const pairedAssetId = pairedAssetGroup.dataset.assetId;
            pairedTransferItem.remove();
            updateTransferSummary(pairedAssetId);
          }
          transferPairs.delete(transferId);
          transferPairs.delete(pairedTransferId);
        }
      }      function updateTransferSummary(assetId) {
        const transfersContainer = document.querySelector(`.transfers-container[data-asset-id="${assetId}"]`);
        const assetGroup = transfersContainer.closest('.asset-group');
        const summaryDiv = assetGroup.querySelector('.transfer-summary');
        const summaryText = summaryDiv.querySelector('.transfer-summary-text');

        if (!transfersContainer || !summaryDiv || !summaryText) return;

        const transferItems = transfersContainer.querySelectorAll('.transfer-item');
        let totalIn = 0;
        let totalOut = 0;
        let transferCount = 0;

        transferItems.forEach(item => {
          const type = item.querySelector('.transfer-type-select').value;
          const asset = item.querySelector('.transfer-asset-select').value;
          const amount = parseFloat(item.querySelector('.transfer-amount-input').value) || 0;

          if (asset && amount > 0) {
            transferCount++;
            if (type === 'from') {
              totalIn += amount;
            } else if (type === 'to') {
              totalOut += amount;
            }
          }
        });

        if (transferCount > 0) {
          summaryDiv.classList.add('has-transfers');
          const netTransfer = totalIn - totalOut;
          const assetName = assetGroup.querySelector('.asset-name').textContent;
          
          // Determine currency symbol
          let currencySymbol = '¥';
          if (assetName === 'StockAward') {
            currencySymbol = '$';
          }

          let summaryContent = '';
          if (totalIn > 0) {
            summaryContent += `In: ${currencySymbol}${totalIn.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
          }
          if (totalOut > 0) {
            if (summaryContent) summaryContent += ' | ';
            summaryContent += `Out: ${currencySymbol}${totalOut.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
          }
          if (netTransfer !== 0) {
            const netLabel = netTransfer > 0 ? 'Net In' : 'Net Out';
            const netAmount = Math.abs(netTransfer);
            if (summaryContent) summaryContent += ' | ';
            summaryContent += `${netLabel}: ${currencySymbol}${netAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
          }

          summaryText.textContent = summaryContent;
        } else {
          summaryDiv.classList.remove('has-transfers');
        }
      }      // Listen for postMessage from parent window (host.html)
      window.addEventListener('message', function(event) {
        console.log('Message received in asset-input:', event.data);
        
        if (event.data.type === 'INITIALIZE_ASSETS' && event.data.assets) {
          console.log('Initializing assets with data:', event.data.assets);
          assets = event.data.assets;
          // Clear overridden dates and transfer pairs when new assets are loaded
          overriddenDates.clear();
          transferPairs.clear();
          transferIdCounter = 0;
          generateAllAssets();
          // Removed: sending confirmation back to parent
        }
      });// Generate all assets on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize date picker with today's date
        initializeDatePicker();
        // Generate all assets (they will be expanded by default)
        generateAllAssets();
      });
    </script>
  </body>
</html>
