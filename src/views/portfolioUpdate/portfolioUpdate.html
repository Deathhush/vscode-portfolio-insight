<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Value Input</title>
    <style>      /* VS Code theme detection classes */
      .vscode-light {
        --bg-primary: #ffffff;
        --bg-secondary: #f3f3f3;
        --bg-tertiary: #e8e8e8;
        --bg-quaternary: #e8e8e8;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-muted: #666666;
        --text-accent: #0078d4;
        --border-primary: #d1d1d1;
        --border-secondary: #e5e5e5;
        --shadow-primary: rgba(0, 0, 0, 0.1);
        --shadow-secondary: rgba(0, 0, 0, 0.05);
        --input-bg: #ffffff;
        --input-border: #cccccc;
        --input-focus: #0078d4;
        --input-placeholder: #999;
        --button-bg: #0078d4;
        --button-text: #ffffff;
        --button-hover-bg: #106ebe;
        --badge-simple-bg: #e6f2ff;
        --badge-simple-text: #1e40af;
        --badge-investment-bg: #fff8e1;
        --badge-investment-text: #f57c00;
        --badge-composite-bg: #f3e8ff;
        --badge-composite-text: #7c3aed;
        --badge-stock-bg: #e0f8f8;
        --badge-stock-text: #0891b2;
        --currency-bg: #333333;
        --currency-text: #ffffff;
        --summary-bg: #f3f3f3;
        --summary-text: #666666;
        --summary-value: #333333;
        --header-active-bg: linear-gradient(135deg, #f3f3f3 0%, #e8e8e8 100%);
        --overridden-bg: #fff8e1;
        --overridden-border: #0078d4;
        --transfer-btn-bg: #0078d4;
        --transfer-btn-hover: #106ebe;
        --transfer-btn-active: #106ebe;
        --transfer-btn-active-hover: #005a9e;
        --add-btn-bg: #388e3c;
        --add-btn-hover: #2e7d32;
        --remove-btn-bg: #d32f2f;
        --remove-btn-hover: #c62828;
        --error-color: #d32f2f;
        --success-color: #388e3c;
        --warning-color: #f57c00;
      }

      .vscode-dark {
        --bg-primary: #1e1e1e;
        --bg-secondary: #252526;
        --bg-tertiary: #2d2d30;
        --bg-quaternary: #2d2d30;
        --text-primary: #cccccc;
        --text-secondary: #969696;
        --text-muted: #969696;
        --text-accent: #4fc3f7;
        --border-primary: #3c3c3c;
        --border-secondary: #404040;
        --shadow-primary: rgba(0, 0, 0, 0.4);
        --shadow-secondary: rgba(0, 0, 0, 0.3);
        --input-bg: #3c3c3c;
        --input-border: #5a5a5a;
        --input-focus: #4fc3f7;
        --input-placeholder: #8a8a8a;
        --button-bg: #0e639c;
        --button-text: #ffffff;
        --button-hover-bg: #1177bb;
        --badge-simple-bg: rgba(30, 64, 175, 0.2);
        --badge-simple-text: #60a5fa;
        --badge-investment-bg: rgba(255, 152, 0, 0.2);
        --badge-investment-text: #ff9800;
        --badge-composite-bg: rgba(124, 58, 237, 0.2);
        --badge-composite-text: #a78bfa;
        --badge-stock-bg: rgba(8, 145, 178, 0.2);
        --badge-stock-text: #22d3ee;
        --currency-bg: #252526;
        --currency-text: #cccccc;
        --summary-bg: #252526;
        --summary-text: #969696;
        --summary-value: #cccccc;
        --header-active-bg: linear-gradient(135deg, #252526 0%, #2d2d30 100%);
        --overridden-bg: rgba(255, 152, 0, 0.15);
        --overridden-border: #4fc3f7;
        --transfer-btn-bg: #0e639c;
        --transfer-btn-hover: #1177bb;
        --transfer-btn-active: #1177bb;
        --transfer-btn-active-hover: #0e639c;
        --add-btn-bg: #4caf50;
        --add-btn-hover: #388e3c;
        --remove-btn-bg: #f44336;
        --remove-btn-hover: #d32f2f;
        --error-color: #f44336;
        --success-color: #4caf50;
        --warning-color: #ff9800;
      }

      .vscode-high-contrast {
        --bg-primary: #000000;
        --bg-secondary: #000000;
        --bg-tertiary: #000000;
        --bg-quaternary: #000000;
        --text-primary: #ffffff;
        --text-secondary: #ffffff;
        --text-muted: #ffffff;
        --text-accent: #ffffff;
        --border-primary: #ffffff;
        --border-secondary: #ffffff;
        --shadow-primary: rgba(255, 255, 255, 0.1);
        --shadow-secondary: rgba(255, 255, 255, 0.05);
        --input-bg: #000000;
        --input-border: #ffffff;
        --input-focus: #ffffff;
        --input-placeholder: #ffffff;
        --button-bg: #ffffff;
        --button-text: #000000;
        --button-hover-bg: #ffffff;
        --badge-simple-bg: #000000;
        --badge-simple-text: #ffffff;
        --badge-investment-bg: #000000;
        --badge-investment-text: #ffffff;
        --badge-composite-bg: #000000;
        --badge-composite-text: #ffffff;
        --badge-stock-bg: #000000;
        --badge-stock-text: #ffffff;
        --currency-bg: #000000;
        --currency-text: #ffffff;
        --summary-bg: #000000;
        --summary-text: #ffffff;
        --summary-value: #ffffff;
        --header-active-bg: #000000;
        --overridden-bg: #000000;
        --overridden-border: #ffffff;
        --transfer-btn-bg: #ffffff;
        --transfer-btn-hover: #ffffff;
        --transfer-btn-active: #ffffff;
        --transfer-btn-active-hover: #ffffff;
        --add-btn-bg: #ffffff;
        --add-btn-hover: #ffffff;
        --remove-btn-bg: #ffffff;
        --remove-btn-hover: #ffffff;
        --error-color: #ff0000;
        --success-color: #00ff00;
        --warning-color: #ffff00;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        padding: 20px;
        line-height: 1.6;
        font-size: 16px;
        transition: background-color 0.3s ease, color 0.3s ease;
      }.container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--bg-secondary);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-primary);
        overflow: hidden;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }      .header {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        color: var(--text-accent);
        padding: 15px;
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-primary);
        border-radius: 8px 8px 0 0;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        pointer-events: none;
      }
      .header h1 {
        font-size: 1.6em;
        margin-bottom: 5px;
        font-weight: 300;
        color: var(--text-accent);
        text-shadow: none;
        position: relative;
        z-index: 1;
      }

      .header p {
        opacity: 0.9;
        font-size: 0.9em;
        color: var(--text-secondary);
        position: relative;
        z-index: 1;
      }

      .date-picker-container {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }      .date-picker-container label {
        font-size: 0.9em;
        opacity: 0.9;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .date-picker {
        padding: 6px 10px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        font-size: 0.9em;
        outline: none;
        transition: all 0.3s ease;
      }

      .date-picker:focus {
        background-color: var(--input-bg);
        border-color: var(--input-focus);
        box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
      }      .date-picker::-webkit-calendar-picker-indicator {
        filter: brightness(0) saturate(100%) invert(51%) sepia(85%) saturate(2313%) hue-rotate(176deg) brightness(97%) contrast(98%);
        cursor: pointer;
      }
      .send-update-btn {
        background: var(--button-bg);
        color: var(--button-text);
        border: 1px solid var(--button-bg);
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }

      .send-update-btn:hover {
        background: var(--button-hover-bg);
        border-color: var(--button-hover-bg);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px var(--shadow-primary);
      }

      .send-update-btn:active {
        transform: translateY(0);
      }
      .assets-container {
        padding: 15px;
        background: var(--bg-secondary);
      }

      .account-group {
        margin-bottom: 20px;
        border: 2px solid var(--border-primary);
        border-radius: 8px;
        background: var(--bg-primary);
        overflow: hidden;
        transition: box-shadow 0.3s ease, border-color 0.3s ease;
      }

      .account-group:hover {
        box-shadow: 0 4px 12px var(--shadow-primary);
        border-color: var(--text-accent);
      }

      .account-header {
        background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-quaternary) 100%);
        padding: 16px;
        border-bottom: 1px solid var(--border-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .account-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .account-name {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--text-primary);
      }

      .account-type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75em;
        font-weight: 600;
        text-transform: uppercase;
        background: var(--text-accent);
        color: var(--button-text);
      }

      .account-assets {
        padding: 8px;
        background: var(--bg-secondary);
      }

      .account-assets .asset-group {
        margin-bottom: 8px;
        border: 1px solid var(--border-secondary);
      }

      .standalone-assets {
        margin-bottom: 20px;
        border: 2px solid var(--border-primary);
        border-radius: 8px;
        background: var(--bg-primary);
        overflow: hidden;
      }

      .standalone-assets-header {
        background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-quaternary) 100%);
        padding: 16px;
        border-bottom: 1px solid var(--border-secondary);
      }

      .standalone-assets-title {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--text-primary);
      }

      .standalone-assets .asset-group {
        margin: 8px;
        margin-bottom: 8px;
        border: 1px solid var(--border-secondary);
      }

      .asset-group {
        margin-bottom: 12px;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        overflow: hidden;
        transition: box-shadow 0.3s ease, border-color 0.3s ease;
      }

      .asset-group:hover {
        box-shadow: 0 2px 8px var(--shadow-primary);
      }

      .asset-header {
        background: var(--bg-tertiary);
        padding: 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
      }

      .asset-header:hover {
        background: var(--bg-quaternary);
      }

      .asset-header.active {
        background: var(--header-active-bg);
      }

      .asset-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .asset-date-picker {
        padding: 4px 8px;
        border: 1px solid var(--border-secondary);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        font-size: 0.8em;
        outline: none;
        transition: all 0.3s ease;
        min-width: 130px;
      }

      .asset-date-picker:focus {
        border-color: var(--input-focus);
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      }

      .asset-date-picker.overridden {
        border-color: var(--overridden-border);
        background-color: var(--overridden-bg);
      }
      .asset-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .asset-type-badge {
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.7em;
        font-weight: 600;
        text-transform: uppercase;
      }
      .type-simple {
        background: var(--badge-simple-bg);
        color: var(--badge-simple-text);
      }

      .type-investment {
        background: var(--badge-investment-bg);
        color: var(--badge-investment-text);
      }

      .type-composite {
        background: var(--badge-composite-bg);
        color: var(--badge-composite-text);
      }

      .type-stock {
        background: var(--badge-stock-bg);
        color: var(--badge-stock-text);
      }

      .asset-name {
        font-size: 1em;
        font-weight: 600;
        color: var(--text-primary);
      }

      .currency-label {
        background: var(--currency-bg);
        color: var(--currency-text);
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 0.7em;
        margin-left: 8px;
      }

      .collapse-icon {
        font-size: 1.2em;
        transition: transform 0.3s ease;
        color: var(--text-secondary);
      }

      .collapse-icon.rotated {
        transform: rotate(180deg);
      }
      .asset-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        background: var(--bg-secondary);
      }

      .asset-content.expanded {
        max-height: 600px;
        padding: 15px;
        overflow-y: auto;
      }

      .input-group {
        margin-bottom: 12px;
      }

      .input-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9em;
      }

      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid var(--input-border);
        border-radius: 4px;
        font-size: 0.9em;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: border-color 0.3s ease, box-shadow 0.3s ease,
          background-color 0.3s ease;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--input-focus);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .value-summary {
        background: var(--summary-bg);
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
        transition: background-color 0.3s ease;
      }

      .value-summary.has-value {
        display: block;
      }

      .summary-text {
        color: var(--summary-text);
        font-size: 0.8em;
      }

      .summary-value {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--summary-value);
        margin-top: 3px;
      }
      .transfers-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-primary);
        display: none;
        transition: border-color 0.3s ease;
      }

      .transfers-section.visible {
        display: block;
      }

      .transfers-header {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .transfer-toggle-btn {
        background: var(--transfer-btn-bg);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.7em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-right: 8px;
      }

      .transfer-toggle-btn:hover {
        background: var(--transfer-btn-hover);
      }
      .transfer-toggle-btn.active {
        background: var(--transfer-btn-active);
      }

      .transfer-toggle-btn.active:hover {
        background: var(--transfer-btn-active-hover);
      }

      .transfers-help {
        font-size: 0.75em;
        color: var(--text-muted);
        font-weight: normal;
        font-style: italic;
        margin-left: auto;
      }      .transfers-icon {
        color: var(--text-accent);
        font-size: 1em;
      }
      .transfer-item {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 8px;
        position: relative;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .transfer-item[data-is-paired="true"] {
        background: var(--header-active-bg);
        border-color: var(--input-focus);
      }      .transfer-item[data-is-paired="true"]::before {
        content: "↔";
        position: absolute;
        top: 4px;
        left: 4px;
        color: var(--text-accent);
        font-size: 0.8em;
        font-weight: bold;
      }

      .transfer-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .transfer-row:last-child {
        margin-bottom: 0;
      }      .transfer-type-select {
        flex: 0 0 70px;
        padding: 4px 6px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }
      .transfer-asset-select {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
        min-width: 140px;
      }
      .transfer-date-input {
        flex: 0 0 100px;
        padding: 4px 6px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }

      .transfer-date-input.overridden {
        background-color: var(--overridden-bg);
        border-color: var(--overridden-border);
        box-shadow: 0 0 0 1px var(--overridden-border);
      }

      .transfer-date-input.overridden:focus {
        background-color: var(--overridden-bg);
        border-color: var(--input-focus);
        box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
      }

      .transfer-amount-input {
        width: 120px;
        padding: 4px 4px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        text-align: right;
        background: var(--input-bg);
        color: var(--text-primary);
      }
      .transfer-description-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }
      .transfer-description-input::placeholder {
        color: var(--input-placeholder);
      }

      /* Buy/Sell specific input fields */
      .transfer-shares-input,
      .transfer-unitprice-input,
      .transfer-totalvalue-input {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
        margin-right: 8px;
        text-align: right;
      }

      .transfer-shares-input:last-child,
      .transfer-unitprice-input:last-child,
      .transfer-totalvalue-input:last-child {
        margin-right: 0;
      }

      .remove-transfer-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--remove-btn-bg);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .remove-transfer-btn:hover {
        background: var(--remove-btn-hover);
      }

      .add-transfer-btn {
        background: var(--add-btn-bg);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 0.8em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .add-transfer-btn:hover {
        background: var(--add-btn-hover);
      }

      .transfer-summary {
        margin-top: 8px;
        padding: 8px;
        background: var(--badge-simple-bg);
        border-radius: 4px;
        font-size: 0.8em;
        color: var(--badge-simple-text);
        display: none;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .transfer-summary.has-transfers {
        display: block;
      }

      .income-expenses-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e1e5e9;
        display: none;
      }

      .income-expenses-section.visible {
        display: block;
      }

      .income-expenses-header {
        font-weight: 600;
        color: #333;
        font-size: 0.9em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .income-expenses-toggle-btn {
        background: var(--transfer-btn-bg);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.7em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-right: 8px;
      }

      .income-expenses-toggle-btn:hover {
        background: var(--transfer-btn-hover);
      }

      .income-expenses-toggle-btn.active {
        background: var(--transfer-btn-active);
      }

      .income-expenses-toggle-btn.active:hover {
        background: var(--transfer-btn-active-hover);
      }

      .income-expenses-help {
        font-size: 0.75em;
        color: #666;
        font-weight: normal;
        font-style: italic;
        margin-left: auto;
      }      .income-expenses-icon {
        color: var(--success-color);
        font-size: 1em;
      }.income-expense-item {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 8px;
        position: relative;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .income-expense-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .income-expense-row:last-child {
        margin-bottom: 0;
      }      .income-expense-type-select {
        flex: 0 0 80px;
        padding: 4px 6px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }
      .income-expense-date-input {
        flex: 0 0 100px;
        padding: 4px 6px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }

      .income-expense-date-input.overridden {
        background-color: var(--overridden-bg);
        border-color: var(--overridden-border);
        box-shadow: 0 0 0 1px var(--overridden-border);
      }

      .income-expense-date-input.overridden:focus {
        background-color: var(--overridden-bg);
        border-color: var(--input-focus);
        box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
      }

      .income-expense-amount-input {
        width: 120px;
        padding: 4px 4px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        text-align: right;
        background: var(--input-bg);
        color: var(--text-primary);
      }

      .income-expense-description-input {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        font-size: 0.8em;
        background: var(--input-bg);
        color: var(--text-primary);
      }

      .income-expense-description-input::placeholder {
        color: var(--input-placeholder);
      }      .remove-income-expense-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--remove-btn-bg);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .remove-income-expense-btn:hover {
        background: var(--remove-btn-hover);
      }      .add-income-expense-btn {
        background: var(--add-btn-bg);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 0.8em;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .add-income-expense-btn:hover {
        background: var(--add-btn-hover);
      }

      .income-expense-summary {
        margin-top: 8px;
        padding: 8px;
        background: #e8f5e8;
        border-radius: 4px;
        font-size: 0.8em;
        color: #2e7d32;
        display: none;
      }      
      
      .income-expense-summary.has-items {
        display: block;
      }

      .exchange-rates-section {
        margin-top: 15px;
        padding: 15px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        display: none;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .exchange-rates-section.visible {
        display: block;
      }

      .exchange-rates-header {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1em;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .exchange-rates-icon {
        color: var(--text-accent);
        font-size: 1.2em;
      }

      .exchange-rates-help {
        font-size: 0.8em;
        color: var(--text-muted);
        font-weight: normal;
        font-style: italic;
        margin-left: auto;
      }

      .exchange-rate-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-secondary);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 8px;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .exchange-rate-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .exchange-rate-currency {
        flex: 0 0 80px;
        font-weight: 600;
        font-size: 0.9em;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .exchange-rate-currency::before {
        content: "";
        display: inline-block;
        width: 20px;
        height: 14px;
        background: var(--currency-bg);
        border-radius: 2px;
        font-size: 0.7em;
        color: var(--currency-text);
        text-align: center;
        line-height: 14px;
      }

      .exchange-rate-currency.usd::before {
        content: "$";
      }

      .exchange-rate-currency.eur::before {
        content: "€";
      }

      .exchange-rate-currency.gbp::before {
        content: "£";
      }

      .exchange-rate-currency.jpy::before {
        content: "¥";
      }

      .exchange-rate-equals {
        flex: 0 0 20px;
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .exchange-rate-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        font-size: 0.9em;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        text-align: right;
      }

      .exchange-rate-input:focus {
        outline: none;
        border-color: var(--input-focus);
        box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
      }

      .exchange-rate-cny {
        flex: 0 0 40px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9em;
      }

      @media (max-width: 768px) {
        .container {
          margin: 0;
          border-radius: 0;
        }

        .header {
          padding: 12px;
        }

        .header h1 {
          font-size: 1.4em;
        }

        .assets-container {
          padding: 12px;
        }

        .asset-header {
          padding: 10px;
        }

        .asset-content.expanded {
          padding: 12px;
        }

        .asset-header-right {
          gap: 5px;
        }

        .transfer-toggle-btn {
          font-size: 0.6em;
          padding: 3px 6px;
          margin-right: 4px;
        }

        .asset-date-picker {
          font-size: 0.7em;
          padding: 3px 6px;
          min-width: 110px;
        }

        .date-picker-container {
          flex-direction: column;
          gap: 5px;
        }

        .transfer-row {
          flex-direction: column;
          gap: 6px;
        }
        .transfer-type-select,
        .transfer-asset-select,
        .transfer-date-input,
        .transfer-amount-input {
          flex: none;
          width: 100%;
        }
        .transfers-section {
          margin-top: 12px;
          padding-top: 12px;
        }

        .transfer-item {
          padding: 10px;
        }
        .transfers-help {
          display: none;
        }
      }

      /* Dark mode date picker styling */
      .vscode-dark .date-picker::-webkit-calendar-picker-indicator,
      .vscode-dark .asset-date-picker::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(0.8);
      }

      .vscode-dark .date-picker,
      .vscode-dark .asset-date-picker {
        color-scheme: dark;
      }

      /* High contrast mode adjustments */
      .vscode-high-contrast .date-picker::-webkit-calendar-picker-indicator,
      .vscode-high-contrast
        .asset-date-picker::-webkit-calendar-picker-indicator {
        filter: invert(1) contrast(2);
      }
    </style>
  </head>
  <body class="vscode-dark">
    <div class="container">
      <div class="header">
        <h1>Asset Portfolio</h1>
        <p>Update current values for your assets</p>
        <div class="date-picker-container">
          <label for="portfolioDate">As of:</label>
          <input type="date" id="portfolioDate" class="date-picker" />
          <button class="send-update-btn" onclick="sendAssetUpdate()">
            Save Asset Update
          </button>
        </div>
      </div>     
      <div class="assets-container" id="assetsContainer">
        <!-- Assets will be generated dynamically -->
      </div>
      <div class="exchange-rates-section" id="exchangeRatesSection">
        <div class="exchange-rates-header">
          <span class="exchange-rates-icon">💱</span>
          Exchange Rates
          <span class="exchange-rates-help">Enter rates to convert non-CNY assets</span>
        </div>
        <div class="exchange-rates-container" id="exchangeRatesContainer">
          <!-- Exchange rate items will be generated dynamically -->
        </div>
      </div>
    </div>
    <script>

      // Function to manually set theme (used by host.html)
      function setTheme(themeClass) {
        const body = document.body;

        // Remove existing theme classes
        body.classList.remove(
          "vscode-light",
          "vscode-dark",
          "vscode-high-contrast"
        );

        // Add the specified theme class
        if (
          themeClass &&
          ["vscode-light", "vscode-dark", "vscode-high-contrast"].includes(
            themeClass
          )
        ) {
          body.classList.add(themeClass);
          console.log("Theme set to:", themeClass);
        } else {
          console.warn("Invalid theme class:", themeClass);
          body.classList.add("vscode-light"); // fallback
        }
      }      
      
      // Assets data - default values
      let assets = [];
      let accounts = []; // Track which asset groups have overridden dates
      let overriddenDates = new Set();

      // Track which transfer/income-expense items have overridden dates
      let overriddenTransferDates = new Set();
      let overriddenIncomeExpenseDates = new Set();

      // Exchange rates data
      let exchangeRates = new Map(); // currency -> rate

      // Compute fullName for an asset based on its account context
      function getAssetFullName(asset, accountName = null) {
        if (accountName || asset.account) {
          const account = accountName || asset.account;
          return `${account}.${asset.name}`;
        }
        return asset.name;
      }

      // Get unique non-default currencies from assets
      function getNonDefaultCurrencies() {
        const currencies = new Set();
        assets.forEach(asset => {
          if (asset.currency && asset.currency !== 'CNY') {
            currencies.add(asset.currency);
          }
        });
        return Array.from(currencies).sort();
      }

      // Generate exchange rate section
      function generateExchangeRatesSection() {
        const nonDefaultCurrencies = getNonDefaultCurrencies();
        const exchangeRatesSection = document.getElementById('exchangeRatesSection');
        const exchangeRatesContainer = document.getElementById('exchangeRatesContainer');

        if (nonDefaultCurrencies.length === 0) {
          exchangeRatesSection.classList.remove('visible');
          return;
        }

        exchangeRatesSection.classList.add('visible');
        
        // Generate exchange rate items
        exchangeRatesContainer.innerHTML = nonDefaultCurrencies.map(currency => 
          createExchangeRateItem(currency)
        ).join('');

        // Set initial values from exchangeRates map
        nonDefaultCurrencies.forEach(currency => {
          const input = document.querySelector(`input[data-currency="${currency}"]`);
          if (input && exchangeRates.has(currency)) {
            input.value = exchangeRates.get(currency);
          }
        });
      }

      // Create individual exchange rate item HTML
      function createExchangeRateItem(currency) {
        const currencyClass = currency.toLowerCase();
        return `
          <div class="exchange-rate-item">
            <div class="exchange-rate-row">
              <div class="exchange-rate-currency ${currencyClass}">1 ${currency}</div>
              <div class="exchange-rate-equals">=</div>
              <input type="number" 
                     class="exchange-rate-input" 
                     data-currency="${currency}"
                     placeholder="Enter rate" 
                     step="0.0001" 
                     min="0"
                     oninput="handleExchangeRateChange('${currency}', this)" />
              <div class="exchange-rate-cny">CNY</div>
            </div>
          </div>
        `;
      }

      // Handle exchange rate input changes
      function handleExchangeRateChange(currency, input) {
        const rate = parseFloat(input.value);
        if (rate && rate > 0) {
          exchangeRates.set(currency, rate);
        } else {
          exchangeRates.delete(currency);
        }
      }
      
      // Initialize date picker with today's date
      function initializeDatePicker() {
        const today = new Date();
        const formattedDate = today.toISOString().split("T")[0];
        const headerDatePicker = document.getElementById("portfolioDate");
        headerDatePicker.value = formattedDate;

        // Add event listener for header date picker changes
        headerDatePicker.addEventListener("change", handleHeaderDateChange);
      } // Initialize asset date pickers with header date value
      function initializeAssetDatePickers() {
        const headerDate = document.getElementById("portfolioDate").value;
        const assetDatePickers =
          document.querySelectorAll(".asset-date-picker");

        assetDatePickers.forEach((picker) => {
          const assetId = getAssetId(picker);
          if (!overriddenDates.has(assetId)) {
            picker.value = headerDate;
            picker.classList.remove("overridden");

            // Update transfer and income-expense dates for this asset
            updateTransferDatesForAsset(assetId);
            updateIncomeExpenseDatesForAsset(assetId);
          }
        });
      } // Handle header date picker changes
      function handleHeaderDateChange() {
        const headerDate = document.getElementById("portfolioDate").value;
        const assetDatePickers =
          document.querySelectorAll(".asset-date-picker");

        assetDatePickers.forEach((picker) => {
          const assetId = getAssetId(picker);
          // Only update if this asset date hasn't been overridden
          if (!overriddenDates.has(assetId)) {
            picker.value = headerDate;
            picker.classList.remove("overridden");

            // Update transfer and income-expense dates for this asset
            updateTransferDatesForAsset(assetId);
            updateIncomeExpenseDatesForAsset(assetId);
          }
        });
      } // Handle individual asset date picker changes
      function handleAssetDateChange(picker, event) {
        event.stopPropagation();
        const assetId = getAssetId(picker);
        const headerDate = document.getElementById("portfolioDate").value;

        if (picker.value !== headerDate) {
          // Mark this asset as having an overridden date
          overriddenDates.add(assetId);
          picker.classList.add("overridden");
        } else {
          // If user sets it back to header date, remove override
          overriddenDates.delete(assetId);
          picker.classList.remove("overridden");
        }

        // Update transfer and income-expense dates for this asset
        updateTransferDatesForAsset(assetId);
        updateIncomeExpenseDatesForAsset(assetId);
      } // Get asset ID from a date picker element
      function getAssetId(picker) {
        const assetGroup = picker.closest(".asset-group");
        return assetGroup.getAttribute("data-asset-id");
      }

      // Update transfer dates for an asset when asset date changes
      function updateTransferDatesForAsset(assetId) {
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const assetDate = assetGroup.querySelector(".asset-date-picker").value;
        const transferItems = assetGroup.querySelectorAll(".transfer-item");

        transferItems.forEach((item) => {
          const transferId = item.dataset.transferId;
          const dateInput = item.querySelector(".transfer-date-input");

          // Only update if this transfer date hasn't been overridden
          if (!overriddenTransferDates.has(transferId)) {
            dateInput.value = assetDate;
            dateInput.classList.remove("overridden");
          }
        });
      }

      // Update income-expense dates for an asset when asset date changes
      function updateIncomeExpenseDatesForAsset(assetId) {
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const assetDate = assetGroup.querySelector(".asset-date-picker").value;
        const incomeExpenseItems = assetGroup.querySelectorAll(
          ".income-expense-item"
        );

        incomeExpenseItems.forEach((item) => {
          const incomeExpenseId = item.dataset.incomeExpenseId;
          const dateInput = item.querySelector(".income-expense-date-input");

          // Only update if this income-expense date hasn't been overridden
          if (!overriddenIncomeExpenseDates.has(incomeExpenseId)) {
            dateInput.value = assetDate;
            dateInput.classList.remove("overridden");
          }
        });
      }

      // Handle transfer date changes
      function handleTransferDateChange(transferId, assetId, dateInput) {
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const assetDate = assetGroup.querySelector(".asset-date-picker").value;

        if (dateInput.value !== assetDate) {
          // Mark this transfer as having an overridden date
          overriddenTransferDates.add(transferId);
          dateInput.classList.add("overridden");
        } else {
          // If user sets it back to asset date, remove override
          overriddenTransferDates.delete(transferId);
          dateInput.classList.remove("overridden");
        }

        // Update the paired transfer date as well
        const pairedTransferId = transferPairs.get(transferId);
        if (pairedTransferId) {
          const pairedTransferItem = document.querySelector(
            `[data-transfer-id="${pairedTransferId}"]`
          );
          if (pairedTransferItem) {
            const pairedDateInput = pairedTransferItem.querySelector(
              ".transfer-date-input"
            );
            pairedDateInput.value = dateInput.value;

            // Sync the override status for paired transfer
            if (overriddenTransferDates.has(transferId)) {
              overriddenTransferDates.add(pairedTransferId);
              pairedDateInput.classList.add("overridden");
            } else {
              overriddenTransferDates.delete(pairedTransferId);
              pairedDateInput.classList.remove("overridden");
            }
          }
        }

        handleTransferChange(transferId, assetId);
      }

      // Handle income-expense date changes
      function handleIncomeExpenseDateChange(
        incomeExpenseId,
        assetId,
        dateInput
      ) {
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const assetDate = assetGroup.querySelector(".asset-date-picker").value;

        if (dateInput.value !== assetDate) {
          // Mark this income-expense as having an overridden date
          overriddenIncomeExpenseDates.add(incomeExpenseId);
          dateInput.classList.add("overridden");
        } else {
          // If user sets it back to asset date, remove override
          overriddenIncomeExpenseDates.delete(incomeExpenseId);
          dateInput.classList.remove("overridden");
        }

        handleIncomeExpenseChange(incomeExpenseId, assetId);
      }

      function generateAssetGroup(asset, accountName = null) {
        const currency = asset.currency || "CNY";
        const currencySymbol = currency === "USD" ? "$" : "¥";
        const currencyLabel =
          currency === "USD"
            ? `<span class="currency-label">${currency}</span>`
            : "";

        // Compute fullName for proper identification
        const assetFullName = getAssetFullName(asset, accountName);

        let inputFields = "";
        let summaryText = "";
        let summaryValue = ""; // Generate input fields based on asset type
        switch (asset.type) {
          case "simple":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "investment":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "composite":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Current Value</label>
                            <input type="number" class="input-field" placeholder="Enter current value" 
                                   step="0.01" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Current Market Value</label>
                            <input type="number" class="input-field" placeholder="Enter current market value" 
                                   step="0.01" min="0">
                        </div>`;
            break;

          case "stock":
            inputFields = `
                        <div class="input-group">
                            <label class="input-label">Units/Shares</label>
                            <input type="number" class="input-field" placeholder="Number of shares" 
                                   oninput="updateStockSummary(this)" step="1" min="0" data-field="shares">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Stock Price</label>
                            <input type="number" class="input-field" placeholder="Price per share" 
                                   oninput="updateStockSummary(this)" step="0.01" min="0" data-field="price">
                        </div>`;
            summaryText = "Total Value";
            summaryValue = `${currencySymbol}0.00`;
            break;
        }
        return `
                <div class="asset-group" data-asset-id="${assetFullName}">
                    <div class="asset-header active" onclick="toggleAsset(this)">
                        <div class="asset-info">
                            <span class="asset-type-badge type-${asset.type}">${
          asset.type.charAt(0).toUpperCase() + asset.type.slice(1)
        }</span>
                            <span class="asset-name">${asset.name}</span>
                            ${currencyLabel}
                        </div>                        <div class="asset-header-right">
                            <button type="button" class="transfer-toggle-btn" onclick="toggleTransfers('${assetFullName}', event)" title="Toggle Transfers">
                                <span>⇄</span>
                            </button>
                            ${
                              asset.type === "simple"
                                ? `
                            <button type="button" class="income-expenses-toggle-btn" onclick="toggleIncomeExpenses('${assetFullName}', event)" title="Toggle Income & Expenses">
                                <span>+/-</span>
                            </button>`
                                : ""
                            }
                            <input type="date" class="asset-date-picker" 
                                   onchange="handleAssetDateChange(this, event)" 
                                   onclick="event.stopPropagation()" />
                            <span class="collapse-icon rotated">▼</span>
                        </div>
                    </div>
                    <div class="asset-content expanded">
                        ${inputFields}
                        ${
                          asset.type === "stock"
                            ? `
                        <div class="value-summary">
                            <div class="summary-text">${summaryText}</div>
                            <div class="summary-value">${summaryValue}</div>
                        </div>`
                            : ""
                        }                          <div class="transfers-section">
                            <div class="transfers-header">
                                <span class="transfers-icon">⇄</span>
                                Transfers
                                <span class="transfers-help">Auto-paired with destination</span>
                            </div>
                            <div class="transfers-container" data-asset-id="${assetFullName}">
                                <!-- Transfer items will be added dynamically -->
                            </div>
                            <button type="button" class="add-transfer-btn" onclick="addTransfer('${assetFullName}')">
                                <span>+</span> Add Transfer
                            </button>
                            <div class="transfer-summary">
                                <span class="transfer-summary-text"></span>
                            </div>
                        </div>
                        ${
                          asset.type === "simple"
                            ? `
                          <div class="income-expenses-section">
                            <div class="income-expenses-header">
                                <span class="income-expenses-icon">₊₋</span>
                                Income & Expenses
                                <span class="income-expenses-help">Track cash flows</span>
                            </div>
                            <div class="income-expenses-container" data-asset-id="${assetFullName}">
                                <!-- Income/Expense items will be added dynamically -->
                            </div>
                            <button type="button" class="add-income-expense-btn" onclick="addIncomeExpense('${assetFullName}')">
                              <span>+</span> Add Income/Expense
                            </button>
                            <div class="income-expense-summary">
                                <span class="income-expense-summary-text"></span>
                            </div>
                        </div>`
                            : ""
                        }
                    </div>
                </div>
            `;
      }      
      
      function generateAllAssets() {
        const container = document.getElementById("assetsContainer");
        
        // Group assets by account
        const groupedAssets = groupAssetsByAccount();
        
        let html = '';
        
        // Generate account groups
        groupedAssets.accountGroups.forEach(accountGroup => {
          html += generateAccountGroup(accountGroup);
        });
        
        // Generate standalone assets (assets without accounts)
        if (groupedAssets.standaloneAssets.length > 0) {
          html += generateStandaloneAssetsGroup(groupedAssets.standaloneAssets);
        }
        
        container.innerHTML = html;

        // Initialize asset date pickers with the header date value
        initializeAssetDatePickers();

        // Update all transfer asset dropdowns
        updateAllTransferAssetDropdowns();

        // Generate exchange rates section
        generateExchangeRatesSection();
      }

      function groupAssetsByAccount() {
        const accountGroups = [];
        const standaloneAssets = [];
        
        // Create a map of account names to account data
        const accountMap = new Map();
        accounts.forEach(account => {
          accountMap.set(account.name, account);
        });
        
        // Group assets by their account
        const assetsByAccount = new Map();
        
        assets.forEach(asset => {
          if (asset.account) {
            // Check if we have account data for this account
            let accountData = accountMap.get(asset.account);
            if (!accountData) {
              // Create a default account data if not found
              accountData = { name: asset.account, type: 'unknown' };
              accountMap.set(asset.account, accountData);
            }
            
            if (!assetsByAccount.has(asset.account)) {
              assetsByAccount.set(asset.account, []);
            }
            assetsByAccount.get(asset.account).push(asset);
          } else {
            standaloneAssets.push(asset);
          }
        });
        
        // Create account groups
        assetsByAccount.forEach((assets, accountName) => {
          const accountData = accountMap.get(accountName);
          accountGroups.push({
            account: accountData,
            assets: assets
          });
        });
        
        return {
          accountGroups,
          standaloneAssets
        };
      }

      function generateAccountGroup(accountGroup) {
        const { account, assets } = accountGroup;
        const assetsHtml = assets.map(asset => generateAssetGroup(asset, account.name)).join('');
        
        return `
          <div class="account-group">
            <div class="account-header">
              <div class="account-info">
                <span class="account-name">${account.name}</span>
                <span class="account-type-badge">${account.type}</span>
              </div>
            </div>
            <div class="account-assets">
              ${assetsHtml}
            </div>
          </div>
        `;
      }

      function generateStandaloneAssetsGroup(standaloneAssets) {
        const assetsHtml = standaloneAssets.map(asset => generateAssetGroup(asset)).join('');
        
        return `
          <div class="standalone-assets">
            <div class="standalone-assets-header">
              <span class="standalone-assets-title">Other Assets</span>
            </div>
            <div class="account-assets">
              ${assetsHtml}
            </div>
          </div>
        `;
      }

      function updateAllTransferAssetDropdowns() {
        // Update dropdowns in existing transfer items when assets change
        const transferSelects = document.querySelectorAll(
          ".transfer-asset-select"
        );
        transferSelects.forEach((select) => {
          const transferItem = select.closest(".transfer-item");
          const assetGroup = transferItem.closest(".asset-group");
          const currentAssetId = assetGroup.dataset.assetId;
          const selectedValue = select.value;

          // Find the current asset to determine if it's a stock
          const currentAsset = assets.find(asset => getAssetFullName(asset) === currentAssetId);
          const isStock = currentAsset && currentAsset.type === 'stock';

          // Get list of other assets for the dropdown (exclude current asset and stock assets for traditional transfers)
          const otherAssets = assets.filter(
            (asset) => {
              const assetFullName = getAssetFullName(asset);
              // Exclude current asset
              if (assetFullName === currentAssetId) return false;
              
              // For traditional transfers (non-stock current asset), exclude stock assets
              if (!isStock && asset.type === 'stock') return false;
              
              return true;
            }
          );
          const assetOptions =
            '<option value="">Select asset...</option>' +
            otherAssets
              .map((asset) => {
                const assetFullName = getAssetFullName(asset);
                const displayName = asset.account ? `${asset.account}.${asset.name}` : asset.name;
                return `<option value="${assetFullName}">${displayName}</option>`;
              })
              .join("");

          select.innerHTML = assetOptions;
          // Restore selected value if it still exists
          if (
            selectedValue &&
            otherAssets.some((asset) => getAssetFullName(asset) === selectedValue)
          ) {
            select.value = selectedValue;
          }
        });
      }
      function toggleTransfers(assetId, event) {
        event.stopPropagation(); // Prevent triggering asset toggle

        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const transfersSection = assetGroup.querySelector(".transfers-section");
        const toggleBtn = assetGroup.querySelector(".transfer-toggle-btn");

        if (transfersSection.classList.contains("visible")) {
          transfersSection.classList.remove("visible");
          toggleBtn.classList.remove("active");
        } else {
          transfersSection.classList.add("visible");
          toggleBtn.classList.add("active");

          // Add an empty transfer when section is toggled on
          const transfersContainer = transfersSection.querySelector(
            ".transfers-container"
          );
          if (transfersContainer && transfersContainer.children.length === 0) {
            addTransfer(assetId);
          }
        }
      }

      function toggleAsset(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector(".collapse-icon");

        // Toggle active state
        header.classList.toggle("active");

        // Toggle content visibility
        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          icon.classList.remove("rotated");
        } else {
          content.classList.add("expanded");
          icon.classList.add("rotated");
        }
      }

      function updateSummary(input) {
        const assetGroup = input.closest(".asset-group");
        const summary = assetGroup.querySelector(".value-summary");
        const summaryValue = assetGroup.querySelector(".summary-value");
        const assetName = assetGroup.querySelector(".asset-name").textContent;

        const value = parseFloat(input.value) || 0;

        if (value > 0) {
          summary.classList.add("has-value");

          // Determine currency based on asset
          let currency = "¥";
          if (assetName === "StockAward") {
            currency = "$";
          }

          summaryValue.textContent = `${currency}${value.toLocaleString(
            "en-US",
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            }
          )}`;
        } else {
          summary.classList.remove("has-value");
        }
      }
      function updateStockSummary(input) {
        const assetGroup = input.closest(".asset-group");
        const summary = assetGroup.querySelector(".value-summary");
        const summaryValue = assetGroup.querySelector(".summary-value");
        const assetName = assetGroup.querySelector(".asset-name").textContent;

        // Get both shares and price inputs
        const sharesInput = assetGroup.querySelector(
          'input[data-field="shares"]'
        );
        const priceInput = assetGroup.querySelector(
          'input[data-field="price"]'
        );

        const shares = parseInt(sharesInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const totalValue = shares * price;

        if (shares > 0 && price > 0) {
          summary.classList.add("has-value");

          // Determine currency based on asset
          let currency = "¥";
          if (assetName === "StockAward") {
            currency = "$";
          }
          summaryValue.textContent = `${currency}${totalValue.toLocaleString(
            "en-US",
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            }
          )}`;
        } else {
          summary.classList.remove("has-value");
        }
      }

      // Transfer management functions
      let transferIdCounter = 0;
      let transferPairs = new Map(); // Maps transfer IDs to their corresponding pair IDs

      function addTransfer(assetId) {
        const transfersContainer = document.querySelector(
          `.transfers-container[data-asset-id="${assetId}"]`
        );
        if (!transfersContainer) return;

        const transferId = `transfer_${transferIdCounter++}`;
        const transferItem = createTransferItem(transferId, assetId);
        transfersContainer.appendChild(transferItem);

        // Initialize the date with the asset date
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        const assetDate = assetGroup.querySelector(".asset-date-picker").value;
        const dateInput = transferItem.querySelector(".transfer-date-input");
        dateInput.value = assetDate;

        updateTransferSummary(assetId);
      }

      function createTransferItem(
        transferId,
        currentAssetId,
        isPaired = false
      ) {
        const transferDiv = document.createElement("div");
        transferDiv.className = "transfer-item";
        transferDiv.dataset.transferId = transferId;
        transferDiv.dataset.isPaired = isPaired;

        // Find the current asset to determine if it's a stock
        const currentAsset = assets.find(asset => getAssetFullName(asset) === currentAssetId);
        const isStock = currentAsset && currentAsset.type === 'stock';

        // Get list of other assets for the dropdown (exclude current asset and stock assets for traditional transfers)
        const otherAssets = assets.filter(
          (asset) => {
            const assetFullName = getAssetFullName(asset);
            // Exclude current asset
            if (assetFullName === currentAssetId) return false;
            
            // For traditional transfers (non-stock current asset), exclude stock assets
            if (!isStock && asset.type === 'stock') return false;
            
            return true;
          }
        );
        const assetOptions = otherAssets
          .map((asset) => {
            const assetFullName = getAssetFullName(asset);
            const displayName = asset.account ? `${asset.account}.${asset.name}` : asset.name;
            return `<option value="${assetFullName}">${displayName}</option>`;
          })
          .join("");

        // Create transfer type options based on whether current asset is stock
        let transferTypeOptions = '';
        if (isStock) {
          transferTypeOptions = `
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          `;
        } else {
          transferTypeOptions = `
            <option value="to">To</option>
            <option value="from">From</option>
          `;
        }

        transferDiv.innerHTML = `
          <button type="button" class="remove-transfer-btn" onclick="removeTransfer('${transferId}', '${currentAssetId}')" title="Remove transfer">×</button>
          <div class="transfer-row">
            <select class="transfer-type-select" onchange="handleTransferChange('${transferId}', '${currentAssetId}')">
              ${transferTypeOptions}
            </select>
            <select class="transfer-asset-select" onchange="handleTransferChange('${transferId}', '${currentAssetId}')">
              <option value="">Select asset...</option>
              ${assetOptions}
            </select>
            <input type="date" class="transfer-date-input" 
                   onchange="handleTransferDateChange('${transferId}', '${currentAssetId}', this)" />
            <input type="number" class="transfer-amount-input" placeholder="Amount" step="0.01" min="0" 
                   oninput="handleTransferChange('${transferId}', '${currentAssetId}')" />
          </div>
          <div class="transfer-row" id="buySellRow-${transferId}" style="display: none;">
            <input type="number" class="transfer-shares-input" placeholder="Shares" step="0.01" min="0" 
                   oninput="handleTransferChange('${transferId}', '${currentAssetId}')" />
            <input type="number" class="transfer-unitprice-input" placeholder="Unit Price" step="0.01" min="0" 
                   oninput="handleTransferChange('${transferId}', '${currentAssetId}')" />
            <input type="number" class="transfer-totalvalue-input" placeholder="Total Value" step="0.01" min="0" 
                   oninput="handleTransferChange('${transferId}', '${currentAssetId}')" />
          </div>
          <div class="transfer-row">
            <input type="text" class="transfer-description-input" placeholder="Description (optional)" 
                   oninput="handleDescriptionChange('${transferId}', '${currentAssetId}')" />
          </div>
        `;

        return transferDiv;
      }

      function removeTransfer(transferId, assetId) {
        const transferItem = document.querySelector(
          `[data-transfer-id="${transferId}"]`
        );
        if (transferItem) {
          // Remove paired transfer if it exists
          const pairedTransferId = transferPairs.get(transferId);
          if (pairedTransferId) {
            const pairedTransferItem = document.querySelector(
              `[data-transfer-id="${pairedTransferId}"]`
            );
            if (pairedTransferItem) {
              const pairedAssetGroup =
                pairedTransferItem.closest(".asset-group");
              const pairedAssetId = pairedAssetGroup.dataset.assetId;
              pairedTransferItem.remove();
              updateTransferSummary(pairedAssetId);
            }
            transferPairs.delete(transferId);
            transferPairs.delete(pairedTransferId);
          }

          transferItem.remove();
          updateTransferSummary(assetId);
        }
      }

      function handleTransferChange(transferId, currentAssetId) {
        const transferItem = document.querySelector(
          `[data-transfer-id="${transferId}"]`
        );
        if (!transferItem) return;

        const type = transferItem.querySelector(".transfer-type-select").value;
        const targetAssetId = transferItem.querySelector(
          ".transfer-asset-select"
        ).value;
        const date = transferItem.querySelector(".transfer-date-input").value;
        const amount = transferItem.querySelector(
          ".transfer-amount-input"
        ).value;
        const description = transferItem.querySelector(
          ".transfer-description-input"
        ).value;

        // Show/hide buy/sell specific fields based on transfer type
        const buySellRow = document.getElementById(`buySellRow-${transferId}`);
        const amountInput = transferItem.querySelector(".transfer-amount-input");
        
        if (type === 'buy' || type === 'sell') {
          buySellRow.style.display = 'flex';
          amountInput.style.display = 'none';
          amountInput.placeholder = 'Auto-calculated';
        } else {
          buySellRow.style.display = 'none';
          amountInput.style.display = 'block';
          amountInput.placeholder = 'Amount';
        }

        // For buy/sell operations, calculate amount from shares and price
        let finalAmount = amount;
        if (type === 'buy' || type === 'sell') {
          const shares = transferItem.querySelector(".transfer-shares-input")?.value || 0;
          const unitPrice = transferItem.querySelector(".transfer-unitprice-input")?.value || 0;
          const totalValue = transferItem.querySelector(".transfer-totalvalue-input")?.value || 0;
          
          if (totalValue > 0) {
            finalAmount = totalValue;
          } else if (shares > 0 && unitPrice > 0) {
            finalAmount = shares * unitPrice;
          }
        }

        // Update current asset summary
        updateTransferSummary(currentAssetId);

        // Handle paired transfer - but NOT for buy/sell operations
        // Buy/sell operations are self-contained and don't need paired transfers
        if (type !== 'buy' && type !== 'sell') {
          if (targetAssetId && finalAmount && parseFloat(finalAmount) > 0) {
            createOrUpdatePairedTransfer(
              transferId,
              currentAssetId,
              targetAssetId,
              type,
              finalAmount,
              description,
              date
            );
          } else {
            // Remove paired transfer if target asset or amount is cleared
            removePairedTransfer(transferId);
          }
        } else {
          // For buy/sell operations, always remove any existing paired transfer
          removePairedTransfer(transferId);
        }
      }
      function handleDescriptionChange(transferId, currentAssetId) {
        const transferItem = document.querySelector(
          `[data-transfer-id="${transferId}"]`
        );
        if (!transferItem) return;

        const description = transferItem.querySelector(
          ".transfer-description-input"
        ).value;

        // Update paired transfer description
        const pairedTransferId = transferPairs.get(transferId);
        if (pairedTransferId) {
          const pairedTransferItem = document.querySelector(
            `[data-transfer-id="${pairedTransferId}"]`
          );
          if (pairedTransferItem) {
            const pairedDescriptionInput = pairedTransferItem.querySelector(
              ".transfer-description-input"
            );
            pairedDescriptionInput.value = description;
          }
        }
      }
      function createOrUpdatePairedTransfer(
        transferId,
        sourceAssetId,
        targetAssetId,
        sourceType,
        amount,
        description,
        date
      ) {
        const targetAssetGroup = document.querySelector(
          `[data-asset-id="${targetAssetId}"]`
        );
        if (!targetAssetGroup) return;

        // Auto-toggle transfers section if not visible
        const targetTransfersSection =
          targetAssetGroup.querySelector(".transfers-section");
        const targetToggleBtn = targetAssetGroup.querySelector(
          ".transfer-toggle-btn"
        );
        if (
          targetTransfersSection &&
          !targetTransfersSection.classList.contains("visible")
        ) {
          targetTransfersSection.classList.add("visible");
          targetToggleBtn.classList.add("active");
        }

        const targetTransfersContainer = targetAssetGroup.querySelector(
          ".transfers-container"
        );
        if (!targetTransfersContainer) return;

        // Check if paired transfer already exists
        let pairedTransferId = transferPairs.get(transferId);
        let pairedTransferItem = pairedTransferId
          ? document.querySelector(`[data-transfer-id="${pairedTransferId}"]`)
          : null;

        // If paired transfer doesn't exist or is in wrong container, create new one
        if (
          !pairedTransferItem ||
          !targetTransfersContainer.contains(pairedTransferItem)
        ) {
          // Remove old paired transfer if it exists
          if (pairedTransferItem) {
            pairedTransferItem.remove();
          }

          // Create new paired transfer
          pairedTransferId = `transfer_${transferIdCounter++}`;
          pairedTransferItem = createTransferItem(
            pairedTransferId,
            targetAssetId,
            true
          );
          targetTransfersContainer.appendChild(pairedTransferItem);

          // Link the transfers
          transferPairs.set(transferId, pairedTransferId);
          transferPairs.set(pairedTransferId, transferId);
        } // Update paired transfer values
        // Map the transfer type for the paired transfer
        let pairedType;
        if (sourceType === "buy") {
          pairedType = "from"; // Buy from current asset creates transfer_out on target asset
        } else if (sourceType === "sell") {
          pairedType = "to"; // Sell to target asset creates transfer_in on target asset
        } else {
          pairedType = sourceType === "to" ? "from" : "to"; // Traditional mapping
        }
        
        pairedTransferItem.querySelector(".transfer-type-select").value =
          pairedType;
        pairedTransferItem.querySelector(".transfer-asset-select").value =
          sourceAssetId;
        pairedTransferItem.querySelector(".transfer-date-input").value = date;
        pairedTransferItem.querySelector(".transfer-amount-input").value =
          amount;
        pairedTransferItem.querySelector(".transfer-description-input").value =
          description;

        // Sync override status for paired transfer date
        const originalTransferItem = document.querySelector(
          `[data-transfer-id="${transferId}"]`
        );
        const originalDateInput = originalTransferItem.querySelector(
          ".transfer-date-input"
        );
        const pairedDateInput = pairedTransferItem.querySelector(
          ".transfer-date-input"
        );

        if (originalDateInput.classList.contains("overridden")) {
          overriddenTransferDates.add(pairedTransferId);
          pairedDateInput.classList.add("overridden");
        } else {
          overriddenTransferDates.delete(pairedTransferId);
          pairedDateInput.classList.remove("overridden");
        }

        // Update target asset summary
        updateTransferSummary(targetAssetId);
      }

      function removePairedTransfer(transferId) {
        const pairedTransferId = transferPairs.get(transferId);
        if (pairedTransferId) {
          const pairedTransferItem = document.querySelector(
            `[data-transfer-id="${pairedTransferId}"]`
          );
          if (pairedTransferItem) {
            const pairedAssetGroup = pairedTransferItem.closest(".asset-group");
            const pairedAssetId = pairedAssetGroup.dataset.assetId;
            pairedTransferItem.remove();
            updateTransferSummary(pairedAssetId);
          }
          transferPairs.delete(transferId);
          transferPairs.delete(pairedTransferId);
        }
      }
      function updateTransferSummary(assetId) {
        const transfersContainer = document.querySelector(
          `.transfers-container[data-asset-id="${assetId}"]`
        );
        const assetGroup = transfersContainer.closest(".asset-group");
        const summaryDiv = assetGroup.querySelector(".transfer-summary");
        const summaryText = summaryDiv.querySelector(".transfer-summary-text");

        if (!transfersContainer || !summaryDiv || !summaryText) return;

        const transferItems =
          transfersContainer.querySelectorAll(".transfer-item");
        let totalIn = 0;
        let totalOut = 0;
        let transferCount = 0;

        transferItems.forEach((item) => {
          const type = item.querySelector(".transfer-type-select").value;
          const asset = item.querySelector(".transfer-asset-select").value;
          const amount =
            parseFloat(item.querySelector(".transfer-amount-input").value) || 0;

          if (asset && amount > 0) {
            transferCount++;
            if (type === "from") {
              totalIn += amount;
            } else if (type === "to") {
              totalOut += amount;
            }
          }
        });

        if (transferCount > 0) {
          summaryDiv.classList.add("has-transfers");
          const netTransfer = totalIn - totalOut;
          const assetName = assetGroup.querySelector(".asset-name").textContent;

          // Determine currency symbol
          let currencySymbol = "¥";
          if (assetName === "StockAward") {
            currencySymbol = "$";
          }

          let summaryContent = "";
          if (totalIn > 0) {
            summaryContent += `In: ${currencySymbol}${totalIn.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }
          if (totalOut > 0) {
            if (summaryContent) summaryContent += " | ";
            summaryContent += `Out: ${currencySymbol}${totalOut.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }
          if (netTransfer !== 0) {
            const netLabel = netTransfer > 0 ? "Net In" : "Net Out";
            const netAmount = Math.abs(netTransfer);
            if (summaryContent) summaryContent += " | ";
            summaryContent += `${netLabel}: ${currencySymbol}${netAmount.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }

          summaryText.textContent = summaryContent;
        } else {
          summaryDiv.classList.remove("has-transfers");
        }
      }

      // Income/Expenses management functions
      let incomeExpenseIdCounter = 0;
      function toggleIncomeExpenses(assetId, event) {
        event.stopPropagation(); // Prevent triggering asset toggle

        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        if (!assetGroup) return;

        const incomeExpensesSection = assetGroup.querySelector(
          ".income-expenses-section"
        );
        const toggleBtn = assetGroup.querySelector(
          ".income-expenses-toggle-btn"
        );

        if (incomeExpensesSection.classList.contains("visible")) {
          incomeExpensesSection.classList.remove("visible");
          toggleBtn.classList.remove("active");
        } else {
          incomeExpensesSection.classList.add("visible");
          toggleBtn.classList.add("active");

          // Add an empty income/expense when section is toggled on
          const incomeExpensesContainer = incomeExpensesSection.querySelector(
            ".income-expenses-container"
          );
          if (
            incomeExpensesContainer &&
            incomeExpensesContainer.children.length === 0
          ) {
            addIncomeExpense(assetId);
          }
        }
      }

      function addIncomeExpense(assetId) {
        const incomeExpensesContainer = document.querySelector(
          `.income-expenses-container[data-asset-id="${assetId}"]`
        );
        if (!incomeExpensesContainer) return;

        const incomeExpenseId = `income_expense_${incomeExpenseIdCounter++}`;
        const incomeExpenseItem = createIncomeExpenseItem(
          incomeExpenseId,
          assetId
        );
        incomeExpensesContainer.appendChild(incomeExpenseItem);

        // Initialize the date with the asset date
        const assetGroup = document.querySelector(
          `[data-asset-id="${assetId}"]`
        );
        const assetDate = assetGroup.querySelector(".asset-date-picker").value;
        const dateInput = incomeExpenseItem.querySelector(
          ".income-expense-date-input"
        );
        dateInput.value = assetDate;

        updateIncomeExpenseSummary(assetId);
      }

      function createIncomeExpenseItem(incomeExpenseId, currentAssetId) {
        const incomeExpenseDiv = document.createElement("div");
        incomeExpenseDiv.className = "income-expense-item";
        incomeExpenseDiv.dataset.incomeExpenseId = incomeExpenseId;
        incomeExpenseDiv.innerHTML = `
          <button type="button" class="remove-income-expense-btn" onclick="removeIncomeExpense('${incomeExpenseId}', '${currentAssetId}')" title="Remove income/expense">×</button>
          <div class="income-expense-row">
            <select class="income-expense-type-select" onchange="handleIncomeExpenseChange('${incomeExpenseId}', '${currentAssetId}')">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <input type="date" class="income-expense-date-input" 
                   onchange="handleIncomeExpenseDateChange('${incomeExpenseId}', '${currentAssetId}', this)" />
            <input type="number" class="income-expense-amount-input" placeholder="Amount" step="0.01" min="0" 
                   oninput="handleIncomeExpenseChange('${incomeExpenseId}', '${currentAssetId}')" />
            <input type="text" class="income-expense-description-input" placeholder="Description (optional)" />
          </div>
        `;

        return incomeExpenseDiv;
      }

      function removeIncomeExpense(incomeExpenseId, assetId) {
        const incomeExpenseItem = document.querySelector(
          `[data-income-expense-id="${incomeExpenseId}"]`
        );
        if (incomeExpenseItem) {
          incomeExpenseItem.remove();
          updateIncomeExpenseSummary(assetId);
        }
      }

      function handleIncomeExpenseChange(incomeExpenseId, currentAssetId) {
        updateIncomeExpenseSummary(currentAssetId);
      }

      function updateIncomeExpenseSummary(assetId) {
        const incomeExpensesContainer = document.querySelector(
          `.income-expenses-container[data-asset-id="${assetId}"]`
        );
        const assetGroup = incomeExpensesContainer.closest(".asset-group");
        const summaryDiv = assetGroup.querySelector(".income-expense-summary");
        const summaryText = summaryDiv.querySelector(
          ".income-expense-summary-text"
        );

        if (!incomeExpensesContainer || !summaryDiv || !summaryText) return;

        const incomeExpenseItems = incomeExpensesContainer.querySelectorAll(
          ".income-expense-item"
        );
        let totalIncome = 0;
        let totalExpenses = 0;
        let itemCount = 0;

        incomeExpenseItems.forEach((item) => {
          const type = item.querySelector(".income-expense-type-select").value;
          const amount =
            parseFloat(
              item.querySelector(".income-expense-amount-input").value
            ) || 0;

          if (amount > 0) {
            itemCount++;
            if (type === "income") {
              totalIncome += amount;
            } else if (type === "expense") {
              totalExpenses += amount;
            }
          }
        });

        if (itemCount > 0) {
          summaryDiv.classList.add("has-items");
          const netFlow = totalIncome - totalExpenses;
          const assetName = assetGroup.querySelector(".asset-name").textContent;

          // Determine currency symbol
          let currencySymbol = "¥";
          if (assetName === "StockAward") {
            currencySymbol = "$";
          }

          let summaryContent = "";
          if (totalIncome > 0) {
            summaryContent += `Income: ${currencySymbol}${totalIncome.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }
          if (totalExpenses > 0) {
            if (summaryContent) summaryContent += " | ";
            summaryContent += `Expenses: ${currencySymbol}${totalExpenses.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }
          if (netFlow !== 0) {
            const netLabel = netFlow > 0 ? "Net Income" : "Net Expense";
            const netAmount = Math.abs(netFlow);
            if (summaryContent) summaryContent += " | ";
            summaryContent += `${netLabel}: ${currencySymbol}${netAmount.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}`;
          }

          summaryText.textContent = summaryContent;
        } else {
          summaryDiv.classList.remove("has-items");
        }
      }      // Listen for postMessage from parent window (host.html)
      window.addEventListener("message", function (event) {
        console.log("Message received in asset-input:", event.data);        
        if (event.data.type === "INITIALIZE_PORTFOLIO_DATA" && event.data.portfolioData) {
          console.log("Initializing portfolio data:", event.data.portfolioData);
          const portfolioData = event.data.portfolioData;
          
          // Collect all assets (standalone + account assets)
          assets = [...(portfolioData.assets || [])];
          accounts = portfolioData.accounts || [];
          
          // Add account assets to the main assets array with account reference
          accounts.forEach(account => {
            if (account.assets) {
              account.assets.forEach(asset => {
                // Add account reference to the asset for fullName computation
                const accountAsset = { ...asset, account: account.name };
                assets.push(accountAsset);
              });
            }
          });
          
          // Clear overridden dates and transfer pairs when new data is loaded
          overriddenDates.clear();
          overriddenTransferDates.clear();
          overriddenIncomeExpenseDates.clear();
          transferPairs.clear();
          exchangeRates.clear();
          transferIdCounter = 0;
          incomeExpenseIdCounter = 0;
          generateAllAssets();
        } else if (event.data.type === "SET_THEME") {
          console.log("Setting theme:", event.data.theme);
          setTheme(event.data.theme);
        }
      });

      // Extracted postMessage function for communication with host
      function sendMessageToHost(messageType, data) {
        const message = {
          type: messageType,
          data: data,
        };

        // Send message to VSCode webview if available
        if (typeof acquireVsCodeApi !== "undefined") {
          const vscode = acquireVsCodeApi();
          vscode.postMessage(message);
          console.log("Message sent to VSCode webview:", message);
        } else if (window.parent && window.parent !== window) {
          // Fallback to parent.postMessage for host.html compatibility
          window.parent.postMessage(message, "*");
          console.log("Message sent to host:", message);
        } else {
          console.log(
            "No VSCode API or parent window found, message would be:",
            message
          );
        }
      }      // Collect current asset update data in the format matching assetUpdate.json
      function collectAssetUpdateData() {
        const headerDate = document.getElementById("portfolioDate").value;
        const assetUpdateData = {
          date: headerDate,
          assets: [],
          transfers: [],
        };

        // Add exchange rates if any exist
        if (exchangeRates.size > 0) {
          assetUpdateData.exchangeRates = [];
          exchangeRates.forEach((rate, currency) => {
            assetUpdateData.exchangeRates.push({
              from: currency,
              rate: rate
            });
          });
        }

        // Collect asset data
        assets.forEach((asset) => {
          // Compute fullName for this asset
          const assetFullName = getAssetFullName(asset);
          
          const assetData = {
            name: assetFullName, // Use fullName for portfolio update files
          };

          // Get asset-specific date if overridden
          const assetGroup = document.querySelector(
            `[data-asset-id="${assetFullName}"]`
          );
          if (assetGroup) {
            const assetDatePicker =
              assetGroup.querySelector(".asset-date-picker");
            if (assetDatePicker && overriddenDates.has(assetFullName)) {
              assetData.date = assetDatePicker.value;
            }
          }

          const events = [];

          // Find the asset group and collect snapshot data based on asset type
          if (assetGroup) {
            const inputFields = assetGroup.querySelectorAll(".input-field");

            if (asset.type === "simple") {
              // Simple assets have one input field for current value
              const currentValueInput = inputFields[0];
              if (currentValueInput && currentValueInput.value !== '') {
                events.push({
                  type: "snapshot",
                  currentValue: parseFloat(currentValueInput.value),
                });
              }
            } else if (asset.type === "investment") {
              // Investment assets have one input field for current value
              const currentValueInput = inputFields[0];
              if (currentValueInput && currentValueInput.value !== '') {
                events.push({
                  type: "snapshot",
                  currentValue: parseFloat(currentValueInput.value),
                });
              }
            } else if (asset.type === "composite") {
              // Composite assets have two input fields: current value and market value
              const currentValueInput = inputFields[0];
              const marketValueInput = inputFields[1];

              if (currentValueInput && currentValueInput.value !== '') {
                const snapshotEvent = {
                  type: "snapshot",
                  currentValue: parseFloat(currentValueInput.value),
                };
                if (marketValueInput && marketValueInput.value !== '') {
                  snapshotEvent.marketValue = parseFloat(
                    marketValueInput.value
                  );
                }
                events.push(snapshotEvent);
              }
            } else if (asset.type === "stock") {
              // Stock assets have two input fields: shares and price
              const sharesInput = inputFields[0]; // First field is shares
              const priceInput = inputFields[1]; // Second field is price

              if (
                sharesInput &&
                sharesInput.value &&
                priceInput &&
                priceInput.value
              ) {
                events.push({
                  type: "snapshot",
                  shares: parseFloat(sharesInput.value),
                  price: parseFloat(priceInput.value),
                });
              }
            }
          }

          // Collect income/expense events for this asset
          if (assetGroup) {
            const incomeExpenseSection = assetGroup.querySelector(
              ".income-expenses-container"
            );
            if (incomeExpenseSection) {
              const incomeExpenseItems = incomeExpenseSection.querySelectorAll(
                ".income-expense-item"
              );
              incomeExpenseItems.forEach((item) => {
                const typeSelect = item.querySelector(
                  ".income-expense-type-select"
                );
                const amountInput = item.querySelector(
                  ".income-expense-amount-input"
                );
                const dateInput = item.querySelector(
                  ".income-expense-date-input"
                );
                const descriptionInput = item.querySelector(
                  ".income-expense-description-input"
                );

                if (
                  typeSelect &&
                  typeSelect.value &&
                  amountInput &&
                  amountInput.value
                ) {
                  const event = {
                    type: typeSelect.value,
                    amount: parseFloat(amountInput.value),
                  };

                  if (dateInput && dateInput.value) {
                    event.date = dateInput.value;
                  }

                  if (descriptionInput && descriptionInput.value) {
                    event.description = descriptionInput.value;
                  }

                  events.push(event);
                }
              });
            }
          }

          if (events.length > 0) {
            assetData.events = events;
            assetUpdateData.assets.push(assetData);
          }
        });        // Collect transfer data
        const allAssetGroups = document.querySelectorAll("[data-asset-id]");

        allAssetGroups.forEach((assetGroup) => {
          const transfersContainer = assetGroup.querySelector(
            ".transfers-container"
          );
          if (transfersContainer) {
            const transferItems =
              transfersContainer.querySelectorAll(".transfer-item");
            transferItems.forEach((item) => {
              const transferId = item.dataset.transferId;
              const isPaired = item.dataset.isPaired === "true";

              // Only process user-created transfers, skip auto-paired ones
              if (isPaired) {
                console.log(`Skipping auto-paired transfer ${transferId}`);
                return;
              }

              console.log(`Processing user-created transfer ${transferId}`);

              const typeSelect = item.querySelector(".transfer-type-select");
              const assetSelect = item.querySelector(".transfer-asset-select");
              const amountInput = item.querySelector(".transfer-amount-input");
              const dateInput = item.querySelector(".transfer-date-input");
              const descriptionInput = item.querySelector(
                ".transfer-description-input"
              );

              if (
                typeSelect &&
                typeSelect.value &&
                assetSelect &&
                assetSelect.value
              ) {
                const currentAssetName = assetGroup.dataset.assetId;
                const transferType = typeSelect.value;

                const transfer = {};

                // Handle buy/sell operations vs traditional transfers
                if (transferType === "buy" || transferType === "sell") {
                  // For buy/sell, get data from buy/sell specific fields
                  const sharesInput = item.querySelector(".transfer-shares-input");
                  const unitPriceInput = item.querySelector(".transfer-unitprice-input");
                  const totalValueInput = item.querySelector(".transfer-totalvalue-input");
                  
                  const shares = sharesInput ? parseFloat(sharesInput.value) : 0;
                  const unitPrice = unitPriceInput ? parseFloat(unitPriceInput.value) : 0;
                  const totalValue = totalValueInput ? parseFloat(totalValueInput.value) : 0;
                  
                  if (shares <= 0) {
                    return; // Skip if no shares specified
                  }
                  
                  // Set from/to based on operation type
                  if (transferType === "buy") {
                    transfer.from = assetSelect.value; // Money comes from target asset
                    transfer.to = currentAssetName;    // Shares go to current stock asset
                  } else { // sell
                    transfer.from = currentAssetName;  // Shares come from current stock asset
                    transfer.to = assetSelect.value;   // Money goes to target asset
                  }
                  
                  // Include additional buy/sell data
                  transfer.amount = shares; // Amount represents shares for buy/sell operations
                  if (unitPrice > 0) {
                    transfer.unitPrice = unitPrice;
                  }
                  if (totalValue > 0) {
                    transfer.totalValue = totalValue;
                  }
                  
                } else {
                  // Traditional transfer handling
                  if (!amountInput || !amountInput.value) {
                    return; // Skip if no amount specified
                  }
                  
                  transfer.amount = parseFloat(amountInput.value);
                  
                  if (transferType === "from") {
                    transfer.from = currentAssetName;
                    transfer.to = assetSelect.value;
                  } else { // "to"
                    transfer.from = assetSelect.value;
                    transfer.to = currentAssetName;
                  }
                }

                if (dateInput && dateInput.value) {
                  transfer.date = dateInput.value;
                }

                if (descriptionInput && descriptionInput.value) {
                  transfer.description = descriptionInput.value;
                }

                assetUpdateData.transfers.push(transfer);
              }
            });
          }
        });

        return assetUpdateData;
      } // Send asset update message to host
      function sendAssetUpdate() {
        const assetUpdateData = collectAssetUpdateData();
        console.log("Collected asset update data:", assetUpdateData);
        sendMessageToHost("PORTFOLIO_UPDATE", assetUpdateData);
      }

      // Generate all assets on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize date picker with today's date
        initializeDatePicker();
        // Generate all assets (they will be expanded by default)
        generateAllAssets();
      });
    </script>
  </body>
</html>
