<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Details</title>
    <style>
        /* VS Code theme detection classes */
        .vscode-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #e8e8e8;
            --bg-quaternary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #666666;
            --text-accent: #0078d4;
            --border-primary: #d1d1d1;
            --border-secondary: #e5e5e5;
            --shadow-primary: rgba(0, 0, 0, 0.1);
            --shadow-secondary: rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --input-focus: #0078d4;
            --input-placeholder: #999;
            --button-bg: #0078d4;
            --button-text: #ffffff;
            --button-hover-bg: #106ebe;
            --badge-simple-bg: #e6f2ff;
            --badge-simple-text: #1e40af;
            --badge-investment-bg: #fff8e1;
            --badge-investment-text: #f57c00;
            --badge-composite-bg: #f3e8ff;
            --badge-composite-text: #7c3aed;
            --badge-stock-bg: #e0f8f8;
            --badge-stock-text: #0891b2;
            --currency-bg: #333333;
            --currency-text: #ffffff;
            --summary-bg: #f3f3f3;
            --summary-text: #666666;
            --summary-value: #333333;
            --header-active-bg: linear-gradient(135deg, #f3f3f3 0%, #e8e8e8 100%);
            --overridden-bg: #fff8e1;
            --overridden-border: #0078d4;
            --transfer-btn-bg: #0078d4;
            --transfer-btn-hover: #106ebe;
            --transfer-btn-active: #106ebe;
            --transfer-btn-active-hover: #005a9e;
            --add-btn-bg: #388e3c;
            --add-btn-hover: #2e7d32;
            --remove-btn-bg: #d32f2f;
            --remove-btn-hover: #c62828;
            --error-color: #d32f2f;
            --error-bg: rgba(211, 47, 47, 0.1);
            --error-border: #d32f2f;
            --success-color: #388e3c;
            --warning-color: #f57c00;
        }

        .vscode-dark {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --bg-quaternary: #2d2d30;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --text-muted: #969696;
            --text-accent: #4fc3f7;
            --border-primary: #3c3c3c;
            --border-secondary: #404040;
            --shadow-primary: rgba(0, 0, 0, 0.4);
            --shadow-secondary: rgba(0, 0, 0, 0.3);
            --input-bg: #3c3c3c;
            --input-border: #5a5a5a;
            --input-focus: #4fc3f7;
            --input-placeholder: #8a8a8a;
            --button-bg: #0e639c;
            --button-text: #ffffff;
            --button-hover-bg: #1177bb;
            --badge-simple-bg: rgba(30, 64, 175, 0.2);
            --badge-simple-text: #60a5fa;
            --badge-investment-bg: rgba(255, 152, 0, 0.2);
            --badge-investment-text: #ff9800;
            --badge-composite-bg: rgba(124, 58, 237, 0.2);
            --badge-composite-text: #a78bfa;
            --badge-stock-bg: rgba(8, 145, 178, 0.2);
            --badge-stock-text: #22d3ee;
            --currency-bg: #252526;
            --currency-text: #cccccc;
            --summary-bg: #252526;
            --summary-text: #969696;
            --summary-value: #cccccc;
            --header-active-bg: linear-gradient(135deg, #252526 0%, #2d2d30 100%);
            --overridden-bg: rgba(255, 152, 0, 0.15);
            --overridden-border: #4fc3f7;
            --transfer-btn-bg: #0e639c;
            --transfer-btn-hover: #1177bb;
            --transfer-btn-active: #1177bb;
            --transfer-btn-active-hover: #0e639c;
            --add-btn-bg: #4caf50;
            --add-btn-hover: #388e3c;
            --remove-btn-bg: #f44336;
            --remove-btn-hover: #d32f2f;
            --error-color: #f44336;
            --error-bg: rgba(244, 67, 54, 0.1);
            --error-border: #f44336;
            --success-color: #4caf50;
            --warning-color: #ff9800;
        }

        .vscode-high-contrast {
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --bg-tertiary: #000000;
            --bg-quaternary: #000000;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --text-muted: #ffffff;
            --text-accent: #ffffff;
            --border-primary: #ffffff;
            --border-secondary: #ffffff;
            --shadow-primary: rgba(255, 255, 255, 0.1);
            --shadow-secondary: rgba(255, 255, 255, 0.05);
            --input-bg: #000000;
            --input-border: #ffffff;
            --input-focus: #ffffff;
            --input-placeholder: #ffffff;
            --button-bg: #ffffff;
            --button-text: #000000;
            --button-hover-bg: #ffffff;
            --badge-simple-bg: #000000;
            --badge-simple-text: #ffffff;
            --badge-investment-bg: #000000;
            --badge-investment-text: #ffffff;
            --badge-composite-bg: #000000;
            --badge-composite-text: #ffffff;
            --badge-stock-bg: #000000;
            --badge-stock-text: #ffffff;
            --currency-bg: #000000;
            --currency-text: #ffffff;
            --summary-bg: #000000;
            --summary-text: #ffffff;
            --summary-value: #ffffff;
            --header-active-bg: #000000;
            --overridden-bg: #000000;
            --overridden-border: #ffffff;
            --transfer-btn-bg: #ffffff;
            --transfer-btn-hover: #ffffff;
            --transfer-btn-active: #ffffff;
            --transfer-btn-active-hover: #ffffff;
            --add-btn-bg: #ffffff;
            --add-btn-hover: #ffffff;
            --remove-btn-bg: #ffffff;
            --remove-btn-hover: #ffffff;
            --error-color: #ff0000;
            --error-bg: #000000;
            --error-border: #ff0000;
            --success-color: #00ff00;
            --warning-color: #ffff00;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .asset-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-primary);
        }
        
        .asset-name {
            margin: 0;
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .asset-type-badge {
            background: var(--button-bg);
            color: var(--button-text);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .asset-type-badge.simple {
            background: var(--badge-simple-bg);
            color: var(--badge-simple-text);
            border: 1px solid var(--badge-simple-text);
        }
        
        .asset-type-badge.investment {
            background: var(--badge-investment-bg);
            color: var(--badge-investment-text);
            border: 1px solid var(--badge-investment-text);
        }
        
        .asset-type-badge.composite {
            background: var(--badge-composite-bg);
            color: var(--badge-composite-text);
            border: 1px solid var(--badge-composite-text);
        }
        
        .asset-type-badge.stock {
            background: var(--badge-stock-bg);
            color: var(--badge-stock-text);
            border: 1px solid var(--badge-stock-text);
        }
        
        .asset-key-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .data-item {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            transition: box-shadow 0.2s ease;
        }
        
        .data-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-item .value {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .data-item .sub-value {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .asset-activities {
            margin-top: 40px;
        }
        
        .activities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .activities-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-primary);
        }
        
        .btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background: var(--button-hover-bg);
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border-primary);
        }
        
        .activities-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .activities-table-header {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .activities-table-header .header-type {
            flex: 0 0 90px;
            text-align: center;
            padding: 4px 8px;
        }
        
        .activities-table-header .header-totalvalue {
            flex: 0 0 120px;
            text-align: right;
            padding: 4px 8px;
        }
        
        .activities-table-header .header-amount {
            flex: 0 0 80px;
            text-align: right;
            padding: 4px 8px;
        }
        
        .activities-table-header .header-unitprice {
            flex: 0 0 100px;
            text-align: right;
            padding: 4px 8px;
        }
        
        .activities-table-header .header-date {
            flex: 0 0 100px;
            padding: 4px 0;
        }
        
        .activities-table-header .header-description {
            flex: 1;
            padding: 4px 8px;
        }
        
        .activities-table-header .header-related {
            flex: 0 0 140px;
            text-align: right;
            padding: 4px 0;
        }
        
        .activity-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            position: relative;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        .activity-item:hover {
            background-color: var(--bg-secondary);
            border-color: var(--text-accent);
        }
        
        .activity-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .activity-row:last-child {
            margin-bottom: 0;
        }
        
        .activity-type-badge {
            flex: 0 0 90px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .activity-type-badge.income {
            background: rgba(56, 142, 60, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .activity-type-badge.expense {
            background: rgba(211, 47, 47, 0.15);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        .activity-type-badge.transfer_in {
            background: rgba(25, 118, 210, 0.15);
            color: var(--text-accent);
            border: 1px solid var(--text-accent);
        }
        
        .activity-type-badge.transfer_out {
            background: rgba(156, 39, 176, 0.15);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }
        
        .activity-type-badge.buy {
            background: rgba(76, 175, 80, 0.15);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        
        .activity-type-badge.sell {
            background: rgba(244, 67, 54, 0.15);
            color: #F44336;
            border: 1px solid #F44336;
        }
        
        .activity-type-badge.snapshot {
            background: rgba(121, 85, 72, 0.15);
            color: var(--text-accent);
            border: 1px solid var(--text-accent);
        }
        
        .activity-totalvalue-display {
            flex: 0 0 120px;
            font-size: 1em;
            font-weight: 600;
            text-align: right;
            padding: 4px 8px;
        }
        
        .activity-amount-display {
            flex: 0 0 80px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: right;
            padding: 4px 8px;
            color: var(--text-primary);
        }
        
        .activity-unitprice-display {
            flex: 0 0 100px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: right;
            padding: 4px 8px;
            color: var(--text-secondary);
        }
        
        .activity-totalvalue-display.income {
            color: var(--success-color);
        }
        
        .activity-totalvalue-display.expense {
            color: var(--error-color);
        }
        
        .activity-totalvalue-display.buy {
            color: #4CAF50;
        }
        
        .activity-totalvalue-display.sell {
            color: #F44336;
        }
        
        .activity-totalvalue-display.snapshot {
            color: var(--text-accent);
        }
        
        .activity-date-display {
            flex: 0 0 100px;
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 4px 0;
        }
        
        .activity-description-display {
            flex: 1;
            font-size: 0.9em;
            color: var(--text-primary);
            padding: 4px 8px;
        }
        
        .activity-related-display {
            flex: 0 0 140px;
            font-size: 0.8em;
            color: var(--text-accent);
            font-style: italic;
            text-align: right;
            padding: 4px 0;
        }
        
        .loading {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px;
        }
        
        .error {
            color: var(--error-color);
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--bg-primary);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-primary);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9em;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .activity-type-specific {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .activity-type-specific.active {
            display: block;
        }

        .snapshot-inputs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .snapshot-inputs .form-group {
            flex: 1;
            min-width: 150px;
        }

        .transfer-asset-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9em;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-primary);
        }

        .save-activities-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 999;
        }

        .save-activities-bar:hover {
            background: var(--button-hover-bg);
            transform: translateY(-1px);
        }

        .save-activities-bar.visible {
            display: block;
        }

        .new-activity-row {
            background: var(--border-primary);
            border: 2px solid var(--input-focus);
            position: relative;
        }

        .new-activity-row::before {
            content: "NEW";
            position: absolute;
            top: -8px;
            right: 8px;
            background: var(--input-focus);
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* Animation for smooth loading */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .asset-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .asset-name {
                font-size: 1.5em;
            }
            
            .asset-key-data {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .activities-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .activities-table-header {
                display: none; /* Hide header on mobile for cleaner look */
            }
            
            .activity-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .activity-type-badge,
            .activity-totalvalue-display,
            .activity-amount-display,
            .activity-unitprice-display,
            .activity-date-display,
            .activity-description-display,
            .activity-related-display {
                flex: none;
                width: 100%;
                text-align: left;
            }
            
            .activity-totalvalue-display {
                font-size: 1.1em;
            }
            
            .activity-related-display {
                font-style: normal;
                color: var(--text-secondary);
            }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--bg-primary);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--border-primary);
            color: var(--text-primary);
        }
        
        .modal form {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .form-control, .transfer-asset-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-control:focus, .transfer-asset-select:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        
        .activity-type-specific {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
        }
        
        .activity-type-specific h4 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
        }
        
        .snapshot-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .snapshot-inputs .form-group {
            margin-bottom: 0;
        }
        
        /* For simple/investment assets with only one field, span full width */
        .snapshot-inputs .form-group:only-child {
            grid-column: 1 / -1;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-primary);
        }
    </style>
</head>
<body>    
    <div class="asset-header">
        <h1 class="asset-name" id="assetName">Loading...</h1>
        <span class="asset-type-badge" id="assetType">-</span>
    </div>
    
    <div class="asset-key-data" id="assetKeyData">
        <div class="data-item">
            <label>Current Value</label>
            <div class="value" id="currentValue">Loading...</div>
            <div class="sub-value" id="lastUpdateDate"></div>
        </div>
        <div class="data-item" id="lastMonthIncomeContainer" style="display: none;">
            <label>Last Month Income</label>
            <div class="value" id="lastMonthIncomeValue">-</div>
            <div class="sub-value">For simple assets only</div>
        </div>
    </div>
    
    <div class="asset-activities">
        <div class="activities-header">
            <h2>Recent Activities</h2>
            <div>
                <button id="saveActivitiesButton" class="btn" onclick="saveAllActivities()" style="display: none;">💾 Save Activities</button>
                <button class="btn" onclick="addActivity()">+ Add Activity</button>
            </div>
        </div>
        <div class="activities-list" id="activitiesList">
            <div class="loading">Loading activities...</div>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal" id="addActivityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Activity</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="addActivityForm">
                <div class="form-group">
                    <label for="activityType">Activity Type</label>
                    <select id="activityType" class="form-control" onchange="onActivityTypeChange()">
                        <option value="snapshot">Snapshot (Current Value)</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                        <option value="transfer_in">Transfer In</option>
                        <option value="transfer_out">Transfer Out</option>
                    </select>
                    <small class="activity-type-note" style="font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; display: block;">
                        Available options depend on asset type. Income/Expense only for simple assets.
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="activityDate">Date</label>
                        <input type="date" id="activityDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="activityDescription">Description (optional)</label>
                        <input type="text" id="activityDescription" class="form-control" placeholder="Enter description">
                    </div>
                </div>

                <!-- Snapshot specific fields -->
                <div id="snapshotFields" class="activity-type-specific">
                    <h4>Snapshot Details</h4>
                    <p class="field-description" style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 16px;">
                        Fields shown are specific to the asset type (<span id="assetTypeDisplay"></span>).
                    </p>
                    <div class="snapshot-inputs" id="snapshotInputsContainer">
                        <!-- Dynamic fields will be populated based on asset type -->
                    </div>
                </div>

                <!-- Income/Expense specific fields -->
                <div id="incomeExpenseFields" class="activity-type-specific">
                    <div class="form-group">
                        <label for="incomeExpenseAmount">Amount</label>
                        <input type="number" id="incomeExpenseAmount" class="form-control" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <!-- Transfer specific fields -->
                <div id="transferFields" class="activity-type-specific">
                    <div class="form-row">
                        <div class="form-group" id="transferAmountGroup">
                            <label for="transferAmount">Amount</label>
                            <input type="number" id="transferAmount" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="relatedAsset">Related Asset</label>
                            <select id="relatedAsset" class="transfer-asset-select">
                                <option value="">Select asset...</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Buy/Sell specific fields -->
                    <div id="buySellFields" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="shareAmount">Share Amount *</label>
                            <input type="number" id="shareAmount" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="unitPrice">Unit Price</label>
                            <input type="number" id="unitPrice" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="totalValue">Total Value</label>
                            <input type="number" id="totalValue" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <small style="font-size: 0.8em; color: var(--text-secondary);">
                            <span id="transferNote">For buy/sell operations, either unit price or total value is required.</span>
                        </small>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Add Activity</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        
        // Function to manually set theme (used by host.html if embedded)
        function setTheme(themeClass) {
            document.body.className = themeClass;
        }
        
        // Listen for messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'ASSET_DATA':
                    updateAssetDisplay(message.data);
                    break;
                case 'ERROR':
                    showError(message.data);
                    break;
                case 'ALL_ASSETS':
                    populateAssetsList(message.data);
                    break;
                case 'ACTIVITIES_SAVED':
                    // Clear pending activities since they're now saved
                    pendingActivities = [];
                    hideSaveBar();
                    showSuccessMessage('Activities saved successfully!');
                    // Refresh the data to get the updated activities from the server
                    vscode.postMessage({ type: 'REFRESH_DATA' });
                    break;
                case 'SAVE_ERROR':
                    showErrorMessage('Error saving activities: ' + message.data);
                    break;
            }
        });
        
        function updateAssetDisplay(assetSummary) {
            console.log('Updating asset display with:', assetSummary);
            
            // Store current asset information for later use
            currentAsset = assetSummary.definition;
            
            // Store currency information for activities display
            currentAssetCurrency = assetSummary.currentValue.currency || 'CNY';
            
            // Store the fullName for asset identification (used in transfers and activities)
            currentAssetFullName = assetSummary.fullName || assetSummary.definition.name;
            
            // Update asset header with animation
            const assetNameEl = document.getElementById('assetName');
            const assetTypeEl = document.getElementById('assetType');
            
            // Display the fullName in the header for clarity
            assetNameEl.textContent = currentAssetFullName;
            assetTypeEl.textContent = assetSummary.definition.type;
            
            // Update current value
            const currency = assetSummary.currentValue.currency || 'CNY';
            const currentValue = assetSummary.currentValue.currentValue;
            const valueInCNY = assetSummary.currentValue.valueInCNY;
            
            let valueDisplay = '';
            if (currency === 'CNY') {
                valueDisplay = '¥' + currentValue.toLocaleString('zh-CN', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            } else {
                const originalValue = currentValue.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                const cnyValue = valueInCNY.toLocaleString('zh-CN', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                valueDisplay = `${currency} ${originalValue}<br><small>¥${cnyValue}</small>`;
            }
            
            document.getElementById('currentValue').innerHTML = valueDisplay;
            
            // Update last update date
            if (assetSummary.currentValue.lastUpdateDate) {
                document.getElementById('lastUpdateDate').textContent = 
                    `Last updated: ${new Date(assetSummary.currentValue.lastUpdateDate).toLocaleDateString()}`;
            }
            
            // Update last month income for simple assets
            const lastMonthIncomeContainer = document.getElementById('lastMonthIncomeContainer');
            if (assetSummary.definition.type === 'simple' && assetSummary.lastMonthIncome !== undefined) {
                lastMonthIncomeContainer.style.display = 'block';
                document.getElementById('lastMonthIncomeValue').textContent = 
                    '¥' + assetSummary.lastMonthIncome.toLocaleString('zh-CN', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
            } else {
                lastMonthIncomeContainer.style.display = 'none';
            }
            
            // Update activities
            // Sort activities by date (newest first) for display
            const sortedActivities = [...assetSummary.activities].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB.getTime() - dateA.getTime(); // Newest first
            });
            
            lastLoadedActivities = sortedActivities; // Store sorted activities for later use
            updateActivitiesList(sortedActivities);
        }
        
        function updateActivitiesList(activities) {
            const activitiesList = document.getElementById('activitiesList');
            
            // Combine saved activities with pending activities, with pending activities at the top
            const allActivities = [...pendingActivities, ...activities];
            
            if (allActivities.length === 0) {
                activitiesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div>No activities found.</div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="addActivity()">Add First Activity</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Create table header based on asset type
            let tableHeader = '';
            if (currentAsset && currentAsset.type === 'stock') {
                // For stock assets, show all columns including shares and unit price
                tableHeader = `
                    <div class="activities-table-header">
                        <div class="header-type">Type</div>
                        <div class="header-totalvalue">Total Value</div>
                        <div class="header-amount">Shares</div>
                        <div class="header-unitprice">Unit Price</div>
                        <div class="header-date">Date</div>
                        <div class="header-description">Description</div>
                        <div class="header-related">Related</div>
                    </div>
                `;
            } else {
                // For non-stock assets, show only total value column
                tableHeader = `
                    <div class="activities-table-header">
                        <div class="header-type">Type</div>
                        <div class="header-totalvalue">Total Value</div>
                        <div class="header-date">Date</div>
                        <div class="header-description">Description</div>
                        <div class="header-related">Related</div>
                    </div>
                `;
            }
            
            const activitiesHtml = allActivities.map((activity, index) => {
                const isPending = index < pendingActivities.length; // Pending activities are now at the beginning
                
                let typeDisplay = activity.type.replace('_', ' ');
                
                // Handle different amount fields based on activity type
                let activityAmount = activity.amount;
                // Get total value for the activity
                let totalValue = activity.totalValue;
                
                // Format total value with correct currency
                let totalValueDisplay = '';
                if (currentAssetCurrency === 'CNY') {
                    totalValueDisplay = '¥' + totalValue.toLocaleString('zh-CN', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                } else {
                    totalValueDisplay = currentAssetCurrency + ' ' + totalValue.toLocaleString('en-US', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                }
                
                let totalValueClass = '';
                if (activity.type === 'income' || activity.type === 'transfer_in' || activity.type === 'buy') {
                    totalValueClass = 'income';
                    if (activity.type !== 'snapshot') {
                        totalValueDisplay = '+' + totalValueDisplay;
                    }
                } else if (activity.type === 'expense' || activity.type === 'transfer_out' || activity.type === 'sell') {
                    totalValueClass = 'expense';
                    if (activity.type !== 'snapshot') {
                        totalValueDisplay = '-' + totalValueDisplay;
                    }
                } else if (activity.type === 'snapshot') {
                    totalValueClass = 'snapshot';
                    // For snapshots, the amount is already formatted above without + or -
                }
                
                let relatedAssetDisplay = '';
                if (activity.relatedAsset) {
                    let direction = '';
                    if (activity.type === 'buy') {
                        direction = 'from';
                    } else if (activity.type === 'sell') {
                        direction = 'to';
                    } else {
                        direction = activity.type.includes('in') ? 'from' : 'to';
                    }
                    
                    relatedAssetDisplay = `${direction} ${activity.relatedAsset}`;
                    
                    // For non-stock assets, show detailed buy/sell information in related column
                    if (!currentAsset || currentAsset.type !== 'stock') {
                        if (activity.type === 'buy' || activity.type === 'sell' || 
                            activity.type === 'transfer_in' || activity.type === 'transfer_out') {
                            const detailsArray = [];
                            
                            // Add transaction type for clarity first
                            if (activity.type === 'buy' || activity.type === 'transfer_out') {
                                detailsArray.push('bought');
                            } else if (activity.type === 'sell' || activity.type === 'transfer_in') {
                                detailsArray.push('sold');
                            }
                            
                            // Add share information (only if this is related to stock transactions)
                            if (activity.amount && (activity.unitPrice || activity.exchangeRate)) {
                                const shareDisplay = activity.amount % 1 === 0 ? activity.amount.toString() : activity.amount.toFixed(2);
                                detailsArray.push(`${shareDisplay} shares`);
                            }
                            
                            // Add unit price information with currency if available
                            if (activity.unitPrice && activity.unitPrice !== 1) {
                                // Try to get the currency of the related asset for proper display
                                let priceDisplay = activity.unitPrice.toFixed(2);
                                // If we have the related asset info, we could show its currency
                                // For now, show the formatted price value
                                detailsArray.push(`@ ${priceDisplay}`);
                            }
                            
                            // Add exchange rate information if this involved currency conversion
                            // This would be useful when a CNY cash asset is used to buy USD stock or vice versa
                            if (activity.exchangeRate) {
                                detailsArray.push(`rate: ${activity.exchangeRate.toFixed(4)}`);
                            }
                            
                            // Debug logging to see what's available
                            console.log(`Activity ${activity.id}: type=${activity.type}, amount=${activity.amount}, unitPrice=${activity.unitPrice}, exchangeRate=${activity.exchangeRate}`);
                            
                            if (detailsArray.length > 1) { // More than just the transaction type
                                relatedAssetDisplay += ` (${detailsArray.join(', ')})`;
                            }
                        }
                    }
                }
                
                const itemClass = isPending ? 'activity-item fade-in new-activity-row' : 'activity-item fade-in';
                
                // Generate activity row based on asset type
                let activityRowContent = '';
                if (currentAsset && currentAsset.type === 'stock') {
                    // For stock assets, show all columns
                    const amountDisplay = activity.amount ? activity.amount.toString() : '';
                    const unitPriceDisplay = activity.unitPrice ? activity.unitPrice.toString() : '';
                    
                    activityRowContent = `
                        <div class="activity-row">
                            <div class="activity-type-badge ${activity.type}">${typeDisplay}</div>
                            <div class="activity-totalvalue-display ${totalValueClass}">${totalValueDisplay}</div>
                            <div class="activity-amount-display">${amountDisplay}</div>
                            <div class="activity-unitprice-display">${unitPriceDisplay}</div>
                            <div class="activity-date-display">${new Date(activity.date).toLocaleDateString()}</div>
                            <div class="activity-description-display">${activity.description || ''}</div>
                            <div class="activity-related-display">${relatedAssetDisplay}</div>
                        </div>
                    `;
                } else {
                    // For non-stock assets, show only total value
                    activityRowContent = `
                        <div class="activity-row">
                            <div class="activity-type-badge ${activity.type}">${typeDisplay}</div>
                            <div class="activity-totalvalue-display ${totalValueClass}">${totalValueDisplay}</div>
                            <div class="activity-date-display">${new Date(activity.date).toLocaleDateString()}</div>
                            <div class="activity-description-display">${activity.description || ''}</div>
                            <div class="activity-related-display">${relatedAssetDisplay}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="${itemClass}">
                        ${activityRowContent}
                    </div>
                `;
            }).join('');
            
            activitiesList.innerHTML = tableHeader + activitiesHtml;
        }
        
        function showError(errorData) {
            document.getElementById('assetName').textContent = errorData.assetName || 'Error';
            document.getElementById('assetType').textContent = 'Error';
            document.getElementById('currentValue').textContent = 'Error loading';
            
            const activitiesList = document.getElementById('activitiesList');
            activitiesList.innerHTML = `
                <div class="error">
                    <strong>Error Loading Asset Data</strong><br>
                    ${errorData.message}
                </div>
            `;
        }
        
        // Utility functions for user feedback
        function showUserMessage(message, type = 'info') {
            // Create a message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `user-message ${type}`;
            messageDiv.textContent = message;
            
            // Style the message
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Set background color based on type
            if (type === 'error') {
                messageDiv.style.backgroundColor = '#f44336';
            } else if (type === 'success') {
                messageDiv.style.backgroundColor = '#4caf50';
            } else {
                messageDiv.style.backgroundColor = '#2196f3';
            }
            
            // Add animation keyframes if not already added
            if (!document.getElementById('messageAnimations')) {
                const style = document.createElement('style');
                style.id = 'messageAnimations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Add to document
            document.body.appendChild(messageDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function showErrorMessage(message) {
            showUserMessage(message, 'error');
        }
        
        function showSuccessMessage(message) {
            showUserMessage(message, 'success');
        }
        
        let hasUnsavedChanges = false;
        let allAssets = [];
        let pendingActivities = []; // Track activities that haven't been saved yet
        let lastLoadedActivities = []; // Keep track of the last loaded activities from server
        let currentAsset = null; // Store current asset information for type-specific behavior
        let currentAssetCurrency = 'CNY'; // Store current asset currency for display
        let currentAssetFullName = null; // Store current asset fullName for identification
        
        function addActivity() {
            const modal = document.getElementById('addActivityModal');
            modal.style.display = 'block';
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('activityDate').value = today;
            
            // Reset form
            document.getElementById('addActivityForm').reset();
            document.getElementById('activityDate').value = today;
            
            // Explicitly clear the description field
            document.getElementById('activityDescription').value = '';
            
            // Populate activity type options based on current asset type
            populateActivityTypeOptions();
            
            // Initialize form state - this will show snapshot fields by default
            onActivityTypeChange();
        }
        
        function closeModal() {
            document.getElementById('addActivityModal').style.display = 'none';
        }
        
        function populateActivityTypeOptions() {
            const activityTypeSelect = document.getElementById('activityType');
            let optionsHtml = '<option value="snapshot">Current Value</option>';
            
            // Income and Expense are only available for simple assets
            if (currentAsset && currentAsset.type === 'simple') {
                optionsHtml += '<option value="income">Income</option>';
                optionsHtml += '<option value="expense">Expense</option>';
            }
            
            // Buy/Sell options are only available for stock assets
            if (currentAsset && currentAsset.type === 'stock') {
                optionsHtml += '<option value="buy">Buy</option>';
                optionsHtml += '<option value="sell">Sell</option>';
            }
            
            // Transfer options are only available for non-stock assets
            if (currentAsset && currentAsset.type !== 'stock') {
                optionsHtml += '<option value="transfer_in">Transfer In</option>';
                optionsHtml += '<option value="transfer_out">Transfer Out</option>';
            }
            
            activityTypeSelect.innerHTML = optionsHtml;
            
            // Default to snapshot
            activityTypeSelect.value = 'snapshot';
        }
        
        function generateSnapshotFields(assetType) {
            const container = document.getElementById('snapshotInputsContainer');
            const assetTypeDisplay = document.getElementById('assetTypeDisplay');
            let fieldsHtml = '';
            
            // Update the asset type display
            if (assetTypeDisplay) {
                assetTypeDisplay.textContent = assetType;
            }
            
            switch (assetType) {
                case 'simple':
                    fieldsHtml = `
                        <div class="form-group">
                            <label for="snapshotCurrentValue">Current Value *</label>
                            <input type="number" id="snapshotCurrentValue" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    `;
                    break;
                    
                case 'investment':
                    fieldsHtml = `
                        <div class="form-group">
                            <label for="snapshotCurrentValue">Current Value *</label>
                            <input type="number" id="snapshotCurrentValue" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    `;
                    break;
                    
                case 'composite':
                    fieldsHtml = `
                        <div class="form-group">
                            <label for="snapshotCurrentValue">Current Value *</label>
                            <input type="number" id="snapshotCurrentValue" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="marketValue">Market Value (optional)</label>
                            <input type="number" id="marketValue" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                    `;
                    break;
                    
                case 'stock':
                    fieldsHtml = `
                        <div class="form-group">
                            <label for="shares">Shares/Units *</label>
                            <input type="number" id="shares" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Price per Share *</label>
                            <input type="number" id="price" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    `;
                    break;
                    
                default:
                    // Fallback to show all fields
                    fieldsHtml = `
                        <div class="form-group">
                            <label for="snapshotCurrentValue">Current Value</label>
                            <input type="number" id="snapshotCurrentValue" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="marketValue">Market Value (optional)</label>
                            <input type="number" id="marketValue" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="shares">Shares (optional)</label>
                            <input type="number" id="shares" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="price">Price per Share (optional)</label>
                            <input type="number" id="price" class="form-control" step="0.01" min="0" placeholder="0.00">
                        </div>
                    `;
            }
            
            container.innerHTML = fieldsHtml;
        }
        
        function onActivityTypeChange() {
            const activityType = document.getElementById('activityType').value;
            
            // Hide all type-specific fields and remove required attributes
            document.querySelectorAll('.activity-type-specific').forEach(el => {
                el.style.display = 'none';
                // Remove required attribute from all inputs in hidden sections
                el.querySelectorAll('input[required], select[required]').forEach(input => {
                    input.removeAttribute('required');
                });
            });
            
            // Show relevant fields based on type and add required attributes
            if (activityType === 'snapshot') {
                const snapshotFields = document.getElementById('snapshotFields');
                snapshotFields.style.display = 'block';
                
                // Generate appropriate fields based on current asset type
                if (currentAsset) {
                    generateSnapshotFields(currentAsset.type);
                } else {
                    // Fallback if asset info not available yet
                    generateSnapshotFields('default');
                }
            } else if (activityType === 'income' || activityType === 'expense') {
                const incomeExpenseFields = document.getElementById('incomeExpenseFields');
                incomeExpenseFields.style.display = 'block';
                // Amount is required for income/expense
                document.getElementById('incomeExpenseAmount').setAttribute('required', 'required');
            } else if (activityType === 'transfer_in' || activityType === 'transfer_out' || activityType === 'buy' || activityType === 'sell') {
                const transferFields = document.getElementById('transferFields');
                transferFields.style.display = 'block';
                
                // For buy/sell operations, show additional fields
                if (activityType === 'buy' || activityType === 'sell') {
                    // Show share-based inputs for stock operations
                    showBuySellFields();
                } else {
                    // Show traditional transfer fields
                    showTransferFields();
                }
                
                // Related asset is always required for transfers/buy/sell
                document.getElementById('relatedAsset').setAttribute('required', 'required');
                loadAssetsList();
            }
        }
        
        function loadAssetsList() {
            vscode.postMessage({
                type: 'GET_ALL_ASSETS'
            });
        }
        
        function populateAssetsList(assets) {
            allAssets = assets;
            const select = document.getElementById('relatedAsset');
            const activityType = document.getElementById('activityType').value;
            // Use the stored fullName instead of getting it from the display text
            const currentAssetIdentifier = currentAssetFullName;
            
            select.innerHTML = '<option value="">Select asset...</option>';
            
            assets.forEach(asset => {
                // Compare using the fullName property for accurate filtering
                const assetIdentifier = asset.fullName || asset.name;
                if (assetIdentifier !== currentAssetIdentifier) {
                    // For traditional transfers (transfer_in/transfer_out), exclude stock assets
                    // Stock assets can only participate in buy/sell operations
                    if ((activityType === 'transfer_in' || activityType === 'transfer_out') && asset.type === 'stock') {
                        return; // Skip stock assets for traditional transfers
                    }
                    
                    const option = document.createElement('option');
                    // Use fullName for the value (backend identification) but display name for text
                    option.value = assetIdentifier;
                    option.textContent = `${asset.name} (${asset.type})`;
                    select.appendChild(option);
                }
            });
        }
        
        function showBuySellFields() {
            // Hide traditional transfer amount field
            document.getElementById('transferAmountGroup').style.display = 'none';
            document.getElementById('transferAmount').removeAttribute('required');
            
            // Show buy/sell specific fields
            document.getElementById('buySellFields').style.display = 'flex';
            document.getElementById('shareAmount').setAttribute('required', 'required');
            
            // Update the note
            document.getElementById('transferNote').textContent = 'For buy/sell operations, share amount is required. Either unit price or total value must also be provided.';
        }
        
        function showTransferFields() {
            // Show traditional transfer amount field
            document.getElementById('transferAmountGroup').style.display = 'block';
            document.getElementById('transferAmount').setAttribute('required', 'required');
            
            // Hide buy/sell specific fields
            document.getElementById('buySellFields').style.display = 'none';
            document.getElementById('shareAmount').removeAttribute('required');
            
            // Clear buy/sell fields
            document.getElementById('shareAmount').value = '';
            document.getElementById('unitPrice').value = '';
            document.getElementById('totalValue').value = '';
            
            // Update the note
            document.getElementById('transferNote').textContent = 'Transfer amount is required.';
        }
        
        function showSaveBar() {
            console.log('showSaveBar called - showing save button');
            hasUnsavedChanges = true;
            document.getElementById('saveActivitiesButton').style.display = 'inline-block';
        }
        
        function hideSaveBar() {
            console.log('hideSaveBar called - hiding save button');
            hasUnsavedChanges = false;
            document.getElementById('saveActivitiesButton').style.display = 'none';
        }
        
        function saveAllActivities() {
            console.log(`saveAllActivities called`);
            console.log(`pendingActivities.length: ${pendingActivities.length}`);
            console.log(`pendingActivities content:`, pendingActivities);
            
            if (pendingActivities.length === 0) {
                console.log('No pending activities to save');
                return;
            }
            
            const dataToSend = {
                type: 'SAVE_ACTIVITIES',
                data: pendingActivities
            };
            
            console.log('Sending message to backend:', dataToSend);
            vscode.postMessage(dataToSend);
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Asset page loaded');
            
            // Handle form submission
            document.getElementById('addActivityForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');
                
                const activityType = document.getElementById('activityType').value;
                const date = document.getElementById('activityDate').value;
                const description = document.getElementById('activityDescription').value;
                
                console.log('Activity type:', activityType);
                console.log('Date:', date);
                console.log('Description:', description);
                
                if (!activityType) {
                    console.log('No activity type selected');
                    showErrorMessage('Please select an activity type');
                    return;
                }
                
                // Validate that income/expense are only used with simple assets
                if ((activityType === 'income' || activityType === 'expense') && 
                    (!currentAsset || currentAsset.type !== 'simple')) {
                    showErrorMessage('Income and Expense activities are only available for simple assets');
                    return;
                }
                
                let activityData = {
                    type: activityType,
                    date: date
                };
                
                // Only include description if it's not empty
                if (description && description.trim() !== '') {
                    activityData.description = description.trim();
                }
                
                // Add type-specific fields with validation
                if (activityType === 'snapshot') {
                    if (!currentAsset) {
                        showErrorMessage('Asset information not available. Please try again.');
                        return;
                    }
                    
                    // Handle different asset types
                    if (currentAsset.type === 'simple' || currentAsset.type === 'investment') {
                        const currentValueInput = document.getElementById('snapshotCurrentValue');
                        const currentValue = parseFloat(currentValueInput.value);
                        
                        if (isNaN(currentValue) || currentValue < 0) {
                            showErrorMessage('Please enter a valid current value (0 or greater)');
                            currentValueInput.focus();
                            return;
                        }
                        
                        activityData.currentValue = currentValue;
                        activityData.totalValue = currentValue;  // For snapshots, totalValue equals currentValue
                        
                    } else if (currentAsset.type === 'composite') {
                        const currentValueInput = document.getElementById('snapshotCurrentValue');
                        const currentValue = parseFloat(currentValueInput.value);
                        
                        if (isNaN(currentValue) || currentValue < 0) {
                            showErrorMessage('Please enter a valid current value (0 or greater)');
                            currentValueInput.focus();
                            return;
                        }
                        
                        activityData.currentValue = currentValue;
                        activityData.totalValue = currentValue;  // For snapshots, totalValue equals currentValue
                        
                        // Market value is optional for composite assets
                        const marketValueInput = document.getElementById('marketValue');
                        if (marketValueInput.value !== '') {
                            const marketValue = parseFloat(marketValueInput.value);
                            if (!isNaN(marketValue) && marketValue >= 0) {
                                activityData.marketValue = marketValue;
                            }
                        }
                        
                    } else if (currentAsset.type === 'stock') {
                        const sharesInput = document.getElementById('shares');
                        const priceInput = document.getElementById('price');
                        const shares = parseFloat(sharesInput.value);
                        const price = parseFloat(priceInput.value);
                        
                        if (!shares || shares <= 0) {
                            showErrorMessage('Please enter a valid number of shares');
                            sharesInput.focus();
                            return;
                        }
                        
                        if (!price || price <= 0) {
                            showErrorMessage('Please enter a valid price per share');
                            priceInput.focus();
                            return;
                        }
                        
                        activityData.shares = shares;
                        activityData.price = price;
                        activityData.totalValue = shares * price;  // For stock snapshots, calculate totalValue
                        // For stock assets, the backend will calculate currentValue as shares * price
                    }
                    
                } else if (activityType === 'income' || activityType === 'expense') {
                    const amountInput = document.getElementById('incomeExpenseAmount');
                    const amount = parseFloat(amountInput.value);
                    
                    if (!amount || amount <= 0) {
                        showErrorMessage('Please enter a valid amount');
                        amountInput.focus();
                        return;
                    }
                    activityData.amount = amount;
                    activityData.totalValue = amount;  // For income/expense, totalValue equals amount
                    
                } else if (activityType === 'transfer_in' || activityType === 'transfer_out' || activityType === 'buy' || activityType === 'sell') {
                    const relatedAssetSelect = document.getElementById('relatedAsset');
                    const relatedAsset = relatedAssetSelect.value;
                    
                    if (!relatedAsset) {
                        showErrorMessage('Please select a related asset');
                        relatedAssetSelect.focus();
                        return;
                    }
                    
                    activityData.relatedAsset = relatedAsset;
                    
                    if (activityType === 'buy' || activityType === 'sell') {
                        // Handle buy/sell operations
                        const shareAmountInput = document.getElementById('shareAmount');
                        const unitPriceInput = document.getElementById('unitPrice');
                        const totalValueInput = document.getElementById('totalValue');
                        
                        const shareAmount = parseFloat(shareAmountInput.value);
                        const unitPrice = parseFloat(unitPriceInput.value) || 0;
                        const totalValue = parseFloat(totalValueInput.value) || 0;
                        
                        if (!shareAmount || shareAmount <= 0) {
                            showErrorMessage('Please enter a valid share amount');
                            shareAmountInput.focus();
                            return;
                        }
                        
                        if (unitPrice <= 0 && totalValue <= 0) {
                            showErrorMessage('Please enter either unit price or total value');
                            unitPriceInput.focus();
                            return;
                        }
                        
                        // Set amount and totalValue based on calculation or input
                        if (totalValue > 0) {
                            activityData.amount = shareAmount;  // For UI display of shares
                            activityData.totalValue = totalValue;
                        } else {
                            activityData.amount = shareAmount;  // For UI display of shares
                            activityData.totalValue = shareAmount * unitPrice;
                        }
                        
                        // Store additional buy/sell data for backend processing
                        activityData.shareAmount = shareAmount;
                        if (unitPrice > 0) {
                            activityData.unitPrice = unitPrice;
                        }
                        
                    } else {
                        // Handle traditional transfers
                        const amountInput = document.getElementById('transferAmount');
                        const amount = parseFloat(amountInput.value);
                        
                        if (!amount || amount <= 0) {
                            showErrorMessage('Please enter a valid amount');
                            amountInput.focus();
                            return;
                        }
                        
                        activityData.amount = amount;
                        activityData.totalValue = amount;  // For transfers, totalValue equals amount
                    }
                }
                
                console.log('Sending activity data:', activityData);
                
                // Add the current asset's fullName for proper identification
                activityData.assetName = currentAssetFullName;
                
                console.log('Closing modal and adding activity to pending list');
                closeModal();
                
                // Immediately add to pending activities for UI feedback
                // (This will be saved when user clicks Save Activities)
                pendingActivities.push(activityData);
                console.log(`Activity added to pendingActivities. Total pending: ${pendingActivities.length}`, pendingActivities);
                updateActivitiesList(lastLoadedActivities);
                showSaveBar();
            });
        });
    </script>
</body>
</html>
